<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Zizak ‚Ä¢ Setas</title>
  <script src="https://cdn.tailwindcss.com">// === Gu√≠a de especies (contenido + render) ===</script>
<script>
const SPECIES_GUIDE = [
  { key:'boletus', labelES:'Boletus grupo edulis', labelEU:'Boletus edulis taldea', edible:'excelente', traitsES:[
      'Sombrero pardo; poros blancos‚Üíverdosos; pie robusto con ret√≠culo claro',
      'Carne blanca, no azulea; olor agradable a fruto seco'
    ], traitsEU:[
      'Txanoa marroi; poroak zurixkak‚Üíberdexkak; zurtoin sendoa sare argiarekin',
      'Haragia zuria, ez urdintzen; fruitu lehor usaina'
    ], habitatES:'Hayedos/mixtos maduros; suelos frescos tras lluvias de fin de verano‚Äëoto√±o', habitatEU:'Pago‚Äëbasoak/nahasiak; udazken hasierako eurien ondoko lur freskoa',
    confES:[ 'Tylopilus felleus (amargo): ret√≠culo oscuro y poros rosados; no t√≥xica pero incomible', 'Boletus satanas (t√≥xico, raro): poros rojos, pie rojizo, azuleo marcado' ],
    confEU:[ 'Tylopilus felleus (mingotsa): sare iluna eta poro arrosak; ez toxikoa baina janezina', 'Boletus satanas (toxikoa, arraroa): poro gorriak, zurtoin gorrizta, urdinketa nabarmena' ]
  },
  { key:'cantharellus', labelES:'Cantharellus cibarius (rebozuelo)', labelEU:'Cantharellus cibarius (kantarela)', edible:'muy bueno', traitsES:[
      'Pliegues decurrentes (no l√°minas), olor a albaricoque', 'Carne firme, amarillo uniforme'
    ], traitsEU:[ 'Tolesture jaitsierak (ez orriak), abrikot usaina', 'Haragi trinkoa, hori uniformea' ], habitatES:'Bosques claros; veranos lluviosos y oto√±os h√∫medos', habitatEU:'Basoa argia; uda euritsuak eta udazken hezea',
    confES:[ 'Hygrophoropsis aurantiaca (falso rebozuelo): l√°minas verdaderas, carne blanda', 'Omphalotus illudens (t√≥xico): en tocones, l√°minas, a veces luminiscente' ],
    confEU:[ 'Hygrophoropsis aurantiaca (kantarela faltsua): orri benetakoak, haragi biguna', 'Omphalotus illudens (toxikoa): enborretan, orriak, batzuetan distiratsua' ]
  },
  { key:'lactarius', labelES:'Lactarius deliciosus (n√≠scalo)', labelEU:'Lactarius deliciosus (niskaloa)', edible:'bueno', traitsES:[ 'L√°tex naranja; c√≠rculos conc√©ntricos; verdosea al corte', 'L√°minas decurrentes, pie hueco en adultos' ], traitsEU:[ 'Esne laranja; zirkulu kontzentrikoak; ebakian berdexka', 'Orri jaitsierak, heldutan zurtoin hutsa' ], habitatES:'Pinares (Pinus sylvestris); tras 15‚Äì20 mm de lluvia', habitatEU:'Pinudiak (Pinus sylvestris); 15‚Äì20 mm euriaren ondoren', confES:[ 'L. torminosus (irritante): rosa y muy peludo', 'L. chrysorrheus (l√°tex amarillo, t√≥xico leve)' ], confEU:[ 'L. torminosus (narritagarria): arrosa eta iletsu', 'L. chrysorrheus (esne hori, toxiko arina)' ] },
  { key:'lepista_nuda', labelES:'Lepista nuda (pie azul)', labelEU:'Lepista nuda (oinezko urdina)', edible:'bueno', traitsES:[ 'Sombrero y l√°minas lilas; olor perfumado', 'Esporada rosa‚Äëparda; carne el√°stica' ], traitsEU:[ 'Txanoa eta orriak moreak; usain atsegina', 'Espora hautsa arrosa‚Äëmarroia; haragi malgua' ], habitatES:'Bosques ricos en hojarasca al final de oto√±o‚Äëinvierno', habitatEU:'Hosto‚Äëgeruza ugariko basoak udazken amaiera‚Äënegua', confES:[ 'Entoloma spp. (algunos t√≥xicos): l√°minas que viran a rosa, olor harinoso', 'Cortinarius viol√°ceos (algunos t√≥xicos): cortina ferruginosa' ], confEU:[ 'Entoloma spp. (batzuk toxikoak): orriak arrosarat doaz, irin usaina', 'Cortinarius moreak (batzuk toxikoak): kortina herdoiltsua' ] },
  { key:'hydnum_repandum', labelES:'Hydnum repandum (lengua de vaca)', labelEU:'Hydnum repandum', edible:'bueno', traitsES:[ 'Espinas decurrentes bajo el sombrero', 'Carne blanca, firme; sabor algo amargo en viejos' ], traitsEU:[ 'Azpian orratzak/espinak jaitsierarekin', 'Haragi zuria, trinkoa; zaharretan apur mikatza' ], habitatES:'Hayedos y mixtos frescos de oto√±o', habitatEU:'Pago‚Äëbaso eta nahasi freskoak, udazkena', confES:[ 'Hydnum rufescens (m√°s peque√±o, comestible)' ], confEU:[ 'Hydnum rufescens (txikiagoa, jangarria)' ] },
  { key:'russula_cyanoxantha', labelES:'Russula cyanoxantha (carbonera)', labelEU:'Russula cyanoxantha (ikarogorria)', edible:'bueno', traitsES:[ 'L√°minas flexibles (no quebradizas); cut√≠cula separable', 'Colores variables verdosos‚Äëviol√°ceos' ], traitsEU:[ 'Orri malguak (ez hauskorra); azal uxagarria', 'Kolore aldakorrak: berde‚Äëmore' ], habitatES:'Caducifolios h√∫medos; oto√±o templado', habitatEU:'Hostoerorkor hezeak; udazken epela', confES:[ 'Russula emetica / sardonia (t√≥xicas): sabor muy picante', 'No probar en monte: prueba de sabor no recomendada' ], confEU:[ 'Russula emetica / sardonia (toxikoak): oso min‚Äëzaporea', 'Ez probatu mendian: aho‚Äëproba ez gomendatua' ] },
  { key:'craterellus_cornucopioides', labelES:'Craterellus cornucopioides (trompeta negra)', labelEU:'Craterellus cornucopioides (trompeta beltza)', edible:'excelente', traitsES:[ 'Trompeta hueca, negra‚Äëgris; sin l√°minas', 'Carne delgada, olor agradable' ], traitsEU:[ 'Iturri‚Äëforma hutsa, beltz‚Äëgrisa; orririk gabe', 'Haragi mehea, usain atsegina' ], habitatES:'Hayedos h√∫medos; oto√±os lluviosos', habitatEU:'Pago‚Äëbaso hezeak; udazken euritsua', confES:[ 'Pocas confusiones peligrosas' ], confEU:[ 'Antzekotasun arriskutsuak gutxi' ] },
  { key:'craterellus_tubaeformis', labelES:'Craterellus tubaeformis', labelEU:'Craterellus tubaeformis', edible:'bueno', traitsES:[ 'Sombrero pardo‚Äëamarillo; pliegues decurrentes', 'Pie hueco amarillento' ], traitsEU:[ 'Txano hori‚Äëmarroia; tolesture jaitsierak', 'Zutabe huts horixka' ], habitatES:'Con√≠feras musgosas; finales de oto√±o‚Äëinvierno', habitatEU:'Ihintz‚Äëpinudiak; udazken amaiera‚Äënegua', confES:[ 'Confusiones leves con Cantharellus menores (comestibles)' ], confEU:[ 'Antzekotasun txikiak Cantharellus txikiekin (jangarriak)' ] },
  { key:'hygrophorus_latitabundus', labelES:'Hygrophorus latitabundus (ilarraka)', labelEU:'Hygrophorus latitabundus (ilarreka)', edible:'muy bueno', traitsES:[ 'Sombrero viscoso oliv√°ceo; l√°minas blancas decurrentes', 'Pie robusto; olor agradable' ], traitsEU:[ 'Txano likatsu berde‚Äëolio; orri zuri jaitsieradunak', 'Zurtoin sendoa; usain atsegina' ], habitatES:'Pinares calizos; oto√±o avanzado', habitatEU:'Pinudi karstikoak; udazken aurreratua', confES:[ 'H. persoonii (similar, comestible)' ], confEU:[ 'H. persoonii (antzekoa, jangarria)' ] }
];

function renderSpeciesGuide(){ const lang=getLang(); const modal=document.getElementById('guide-modal'); if(!modal) return; const title=document.getElementById('guide-title'); const desc=document.getElementById('guide-desc'); const warn=document.getElementById('guide-warning'); const search=document.getElementById('guide-search'); title.textContent = (lang==='eu')? 'Espezie gida' : 'Gu√≠a de especies'; desc.textContent=(lang==='eu')? 'Identifikazio azkarrerako fitxak: ezaugarriak, habitata eta antzeko arriskutsuak.' : 'Fichas r√°pidas: rasgos, h√°bitat y confusiones habituales.'; warn.textContent=(lang==='eu')? 'Oharra: ez jan onddoak identifikazio osoa izan gabe. Fitxa hauek orientagarriak dira.' : 'Aviso: no consumas setas sin identificaci√≥n completa. Fichas orientativas.';
  const q=(search?.value||'').toLowerCase(); const grid=document.getElementById('guide-grid'); if(!grid) return; const list = SPECIES_GUIDE.filter(s=>{ const lbl=(lang==='eu'?s.labelEU:s.labelES).toLowerCase(); return !q || lbl.includes(q) || s.key.includes(q); });
  grid.innerHTML = list.map(s=>{ const label=(lang==='eu'?s.labelEU:s.labelES); const traits=(lang==='eu'?s.traitsEU:s.traitsES); const habitat=(lang==='eu'?s.habitatEU:s.habitatES); const conf=(lang==='eu'?s.confEU:s.confES); const color=(SPECIES_META[s.key]?.color||'#374151'); const light=(SPECIES_META[s.key]?.light||'#E5E7EB'); return `<div class="border rounded-lg p-3 bg-white">
    <div class="flex items-center gap-2 mb-1"><span style="color:${color}">‚óè</span><h4 class="font-semibold">${label}</h4></div>
    <p class="text-xs mb-2"><span class="px-2 py-0.5 rounded" style="background:${light}; color:${color}">${(lang==='eu'?'jangarria:':'comestible:')} ${s.edible}</span></p>
    <p class="text-xs text-gray-600 font-semibold mb-1">${lang==='eu'?'Ezaugarri nagusiak':'Rasgos clave'}</p>
    <ul class="list-disc list-inside text-sm text-gray-700 mb-2">${traits.map(x=>`<li>${x}</li>`).join('')}</ul>
    <p class="text-xs text-gray-600 font-semibold mb-1">${lang==='eu'?'Habitat eta garaia':'H√°bitat y √©poca'}</p>
    <p class="text-sm text-gray-700 mb-2">${habitat}</p>
    <p class="text-xs text-gray-600 font-semibold mb-1">${lang==='eu'?'Antzekoak eta kontuz':'Confusiones y precauci√≥n'}</p>
    <ul class="list-disc list-inside text-sm text-gray-700">${conf.map(x=>`<li>${x}</li>`).join('')}</ul>
  </div>`; }).join(''); }

// abrir/cerrar gu√≠a y b√∫squeda
(function(){ const btn=document.getElementById('guide-button'); const modal=document.getElementById('guide-modal'); if(btn&&modal){ btn.onclick=()=>{ renderSpeciesGuide(); modal.style.display='block'; }; const close=modal.querySelector('.close-x'); if(close) close.onclick=()=> modal.style.display='none'; window.addEventListener('click',(e)=>{ if(e.target===modal) modal.style.display='none'; }); const search=document.getElementById('guide-search'); if(search){ search.addEventListener('input', ()=> renderSpeciesGuide()); } }
  // refrescar gu√≠a al cambiar idioma
  const prevToggle=window.__toggleLang; window.__toggleLang=function(){ const r=(prevToggle?prevToggle.apply(this,arguments):null); renderSpeciesGuide(); return r; };
})();

</script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .card-chance-Alta { background-image: linear-gradient(to right, #D1FAE5, #34D399); }
    .card-chance-Media { background-image: linear-gradient(to right, #FEF3C7, #F59E0B); }
    .card-chance-Baja { background-image: linear-gradient(to right, #FEE2E2, #F87171); }
    .loading-spinner { border: 4px solid rgba(0,0,0,0.1); border-left-color: #4CAF50; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .score-breakdown-details { animation: fadeIn 0.25s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px);} to { opacity: 1; transform: translateY(0);} }
    .chip { display: inline-flex; align-items: center; gap:.4rem; padding:.15rem .5rem; border-radius:9999px; font-weight:600; font-size:.75rem; }
    /* Bot√≥n idioma fijo arriba izda */
    #__langToggle{position:fixed;left:12px;top:12px;z-index:9999}
    #__langToggle button{background:#065f46;color:#fff;border-radius:9999px;padding:.35rem .6rem;font-weight:700;font-size:.85rem;box-shadow:0 4px 12px rgba(0,0,0,.14)}
    #__langToggle button:hover{background:#047857}
    /* Ajustes modal */
    .modal { display:none; position:fixed; z-index:1000; inset:0; background:rgba(0,0,0,.45); }
    .modal .content { position:relative; background:#fff; margin:5vh auto; width:95%; max-width:980px; border-radius:16px; padding:20px; }
    .close-x { position:absolute; right:12px; top:10px; font-size:24px; color:#6b7280; cursor:pointer; }
    .grid-field { display:grid; grid-template-columns: 1fr auto; gap:.5rem; align-items:center; }
    .tab { border-bottom:2px solid transparent; padding-bottom:4px; cursor:pointer; }
    .tab.active { border-color:#10b981; color:#065f46; font-weight:700; }
    .section { display:none; }
    .section.active { display:block; }
  </style>
</head>
<body class="bg-green-50 min-h-screen p-6 font-sans">
  <!-- Bot√≥n idioma -->
  <div id="__langToggle"><button id="__langBtn" type="button">Euskara</button></div>

  <header class="text-center mb-8 relative">
    <h1 class="text-4xl font-extrabold text-green-800 mb-2">üçÑ Zizak ‚Ä¢ Setas üå≤</h1>
    <p id="subtitle" class="text-lg text-gray-600" data-i18n="subtitle">Probabilidad general y especies m√°s probables seg√∫n condiciones.</p>
    <div class="absolute top-2 right-2 flex items-center gap-3">
      <button id="guide-button" class="text-gray-400 hover:text-blue-600 text-3xl font-bold leading-none" aria-label="Gu√≠a de especies">üìò</button>
      <button id="help-button" class="text-gray-400 hover:text-green-600 text-3xl font-bold leading-none" aria-label="Ayuda">&#9432;</button>
      <button id="settings-button" class="text-gray-400 hover:text-emerald-600 text-3xl font-bold leading-none" aria-label="Ajustes">‚öôÔ∏è</button>
    </div>
  </header>

  <div id="notification" class="max-w-6xl mx-auto mb-4 hidden p-4 rounded-md text-sm"></div>

  <div class="max-w-6xl mx-auto mb-8 grid grid-cols-1 md:grid-cols-3 gap-6">
    <!-- A√±adir nueva ubicaci√≥n -->
    <div class="bg-white shadow-lg rounded-xl p-5 md:col-span-1">
      <h3 class="text-xl font-bold text-gray-800 mb-4" data-i18n="add.title">A√±adir nueva ubicaci√≥n</h3>
      <div id="add-location-form" class="space-y-4 flex-col">
        <div class="flex-1 flex gap-2">
          <input type="text" id="location-name" data-i18n-ph="add.placeholder" placeholder="Escribe el lugar (ej. Aralar, Navarra)" required class="w-full p-2 border border-gray-300 rounded-md" />
          <button type="button" id="search-button" class="bg-green-600 text-white px-6 py-2 rounded-md font-semibold hover:bg-green-700 transition" data-i18n="add.search">Buscar</button>
        </div>
        <details class="bg-green-50 rounded-md p-3 border border-green-200">
          <summary class="font-semibold text-green-800" data-i18n="add.habitatSummary">Opciones de h√°bitat (opcional)</summary>
          <div class="mt-3 grid grid-cols-1 sm:grid-cols-3 gap-3 text-sm">
            <label class="block">
              <span class="text-gray-700" data-i18n="add.habitatType">Tipo de h√°bitat</span>
              <select id="habitat-select" class="mt-1 block w-full border rounded-md p-2"></select>
            </label>
            <label class="block">
              <span class="text-gray-700" data-i18n="add.age">Edad del arbolado</span>
              <select id="age-select" class="mt-1 block w-full border rounded-md p-2"></select>
            </label>
            <label class="block">
              <span class="text-gray-700" data-i18n="add.soil">Suelo</span>
              <select id="soil-select" class="mt-1 block w-full border rounded-md p-2"></select>
            </label>
          </div>
        </details>
        <div id="search-results" class="mt-2 hidden">
          <p id="search-status" class="text-sm text-gray-500 mb-2"></p>
          <button type="button" id="add-location-btn" class="bg-blue-600 text-white px-6 py-2 rounded-md font-semibold hover:bg-blue-700 transition hidden" data-i18n="add.addBtn">A√±adir a Mis Lugares</button>
        </div>
      </div>
    </div>

    <!-- Fase Lunar -->
    <div id="moon-phase-card" class="bg-white shadow-lg rounded-xl p-5 md:col-span-1 flex flex-col justify-center items-center">
      <h3 class="text-xl font-bold text-gray-800 mb-2 text-center" data-i18n="moon.title">Fase lunar</h3>
      <div class="flex items-center space-x-2">
        <span id="moon-emoji" class="text-4xl"></span>
        <div class="text-gray-700">
          <p id="moon-phase-name" class="font-semibold text-lg"></p>
          <p id="next-full-moon" class="text-xs"></p>
        </div>
      </div>
    </div>

    <!-- Parques -->
    <div class="bg-white shadow-lg rounded-xl p-5 md:col-span-1" id="parks-card">
      <h3 class="text-xl font-bold text-gray-800 mb-2" data-i18n="parks.title">Parques Micol√≥gicos</h3>
      <p class="text-sm text-gray-600 mb-3" id="parks-desc" data-i18n="parks.desc">Consulta la web de:</p>
      <div class="flex flex-wrap gap-2 justify-start">
        <a href="https://parquemicologicoultzama.com/" target="_blank" class="px-4 py-2 bg-green-200 text-green-800 rounded-md font-semibold hover:bg-green-300 transition-colors text-sm">Ultzama</a>
        <a href="https://www.parquemicologicoerro.com/" target="_blank" class="px-4 py-2 bg-green-200 text-green-800 rounded-md font-semibold hover:bg-green-300 transition-colors text-sm">Erro-Arribe</a>
      </div>
    </div>
  </div>

  <!-- Controles -->
  <div id="controls" class="bg-white shadow-lg rounded-xl p-4 mb-8 max-w-6xl mx-auto flex flex-wrap gap-4 items-center justify-between">
    <div class="flex flex-wrap gap-2 items-center">
      <span class="font-semibold text-gray-700" data-i18n="controls.filterBy">Filtrar por:</span>
      <button data-filter="all" class="filter-btn bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-1 rounded-md text-sm" data-i18n="controls.all">Todas</button>
      <button data-filter="Alta" class="filter-btn bg-green-200 hover:bg-green-300 text-green-800 px-3 py-1 rounded-md text-sm" data-i18n="controls.high">Alta</button>
      <button data-filter="Media" class="filter-btn bg-yellow-200 hover:bg-yellow-300 text-yellow-800 px-3 py-1 rounded-md text-sm" data-i18n="controls.mid">Media</button>
      <button data-filter="Baja" class="filter-btn bg-red-200 hover:bg-red-300 text-red-800 px-3 py-1 rounded-md text-sm" data-i18n="controls.low">Baja</button>
    </div>
    <div class="flex flex-wrap gap-2 items-center">
      <span class="font-semibold text-gray-700" data-i18n="controls.sortBy">Ordenar por:</span>
      <button data-sort="name" class="sort-btn bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-1 rounded-md text-sm" data-i18n="controls.name">Nombre</button>
      <button data-sort="chance" class="sort-btn bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-1 rounded-md text-sm" data-i18n="controls.chance">Probabilidad</button>
    </div>
  </div>

  <!-- Grid -->
  <div id="grid-container" class="max-w-6xl mx-auto">
    <p id="loading-message" class="text-center text-gray-700 text-lg hidden" data-i18n="loading">Cargando predicciones... <span class="loading-spinner inline-block align-middle ml-2"></span></p>
    <div id="grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    <div id="welcome-message" class="hidden text-center max-w-2xl mx-auto p-8 bg-white shadow-lg rounded-xl">
      <h2 class="text-2xl font-bold text-green-700 mb-4" data-i18n="welcome.title">¬°Bienvenido/a!</h2>
      <p class="text-gray-600" data-i18n="welcome.text">Empieza a planificar tu pr√≥xima salida al monte a√±adiendo tus lugares favoritos con el buscador de arriba. Las ubicaciones que a√±adas se guardar√°n autom√°ticamente en tu navegador.</p>
    </div>
  </div>

  <!-- Modal de ayuda -->
  <div id="help-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="help-title">
    <div class="content">
      <span class="close-x" aria-label="Cerrar">‚úï</span>
      <h2 id="help-title" class="text-2xl font-bold text-green-800 mb-4" data-i18n="help.title">Acerca de esta aplicaci√≥n</h2>
      <p class="mb-4 text-gray-700" data-i18n="help.p1">Esta aplicaci√≥n estima la probabilidad de encontrar setas combinando condiciones meteorol√≥gicas recientes y un modelo heur√≠stico ajustado a h√°bitats t√≠picos del norte de Navarra.</p>
      <h3 class="font-bold text-lg mb-2" data-i18n="help.how">¬øC√≥mo se calcula la probabilidad?</h3>
      <ul class="list-disc list-inside space-y-2 mb-4 text-sm text-gray-700" id="help-list"></ul>
      <h3 class="font-bold text-lg mb-2" data-i18n="help.speciesMode">Modo especie</h3>
      <ul class="list-disc list-inside space-y-2 mb-4 text-sm text-gray-700" id="help-species"></ul>
      <p class="mt-6 text-xs text-gray-500 italic" data-i18n="help.footer">Recolecta con respeto y jam√°s consumas sin identificaci√≥n total. Esta herramienta es orientativa. Autor√≠a: Amilibia + Experto en Micolog√≠a.</p>
    </div>
  </div>

  <!-- Gu√≠a de especies -->
  <div id="guide-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="guide-title">
    <div class="content">
      <span class="close-x" aria-label="Cerrar">‚úï</span>
      <h2 id="guide-title" class="text-2xl font-bold text-blue-800 mb-2">Gu√≠a de especies</h2>
      <p id="guide-desc" class="text-sm text-gray-600 mb-3">Fichas r√°pidas de identificaci√≥n, h√°bitat y confusiones habituales.</p>
      <div class="mb-3">
        <input id="guide-search" type="text" class="w-full border rounded p-2" placeholder="Buscar especie / Espezie bilatu" />
      </div>
      <div id="guide-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      <p id="guide-warning" class="mt-4 text-xs text-gray-500 italic">Aviso: no consumas setas sin identificaci√≥n completa. Fichas orientativas.</p>
    </div>
  </div>

  <!-- Modal de ajustes -->
  <div id="settings-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="settings-title">
    <div class="content">
      <span class="close-x" aria-label="Cerrar">‚úï</span>
      <h2 id="settings-title" class="text-2xl font-bold text-emerald-800 mb-4" data-i18n="settings.title">Ajustes del modelo</h2>

      <div class="flex gap-6 border-b pb-3 mb-4">
        <button class="tab active" data-tab="general" data-i18n="settings.tabs.general">General</button>
        <button class="tab" data-tab="triggers" data-i18n="settings.tabs.triggers">Disparadores</button>
        <button class="tab" data-tab="species" data-i18n="settings.tabs.species">Especies</button>
      </div>

      <!-- General -->
      <section id="section-general" class="section active space-y-6">
        <div class="grid md:grid-cols-2 gap-6">
          <div class="bg-emerald-50 rounded-lg p-4">
            <h3 class="font-bold text-emerald-800 mb-2" data-i18n="settings.general.smiTitle">Humedad de suelo (SMI)</h3>
            <div class="grid gap-2">
              <label class="grid-field"><span data-i18n="settings.general.smaxAcid">Smax suelo √°cido</span><input data-set="smi.smax.acid" type="number" min="40" max="150" step="1" class="border rounded p-1 w-28"></label>
              <label class="grid-field"><span data-i18n="settings.general.smaxBasic">Smax suelo b√°sico</span><input data-set="smi.smax.basic" type="number" min="40" max="150" step="1" class="border rounded p-1 w-28"></label>
              <label class="grid-field"><span data-i18n="settings.general.smaxDefault">Smax por defecto</span><input data-set="smi.smax.default" type="number" min="40" max="150" step="1" class="border rounded p-1 w-28"></label>
            </div>
          </div>
          <div class="bg-emerald-50 rounded-lg p-4">
            <h3 class="font-bold text-emerald-800 mb-2" data-i18n="settings.general.tempTitle">Temperatura (probabilidad base)</h3>
            <div class="grid gap-2">
              <label class="grid-field"><span data-i18n="settings.general.tOpt">√ìptimo (min‚Äëmax ¬∞C)</span>
                <span>
                  <input data-set="base.temp.optMin" type="number" step="0.5" class="border rounded p-1 w-20">‚Äë
                  <input data-set="base.temp.optMax" type="number" step="0.5" class="border rounded p-1 w-20">
                </span>
              </label>
              <label class="grid-field"><span data-i18n="settings.general.tHeatTh">Castigo calor si T> (¬∞C)</span><input data-set="base.temp.heatThresh" type="number" step="0.5" class="border rounded p-1 w-24"></label>
              <label class="grid-field"><span data-i18n="settings.general.tOptPts">Puntos por √≥ptimo</span><input data-set="base.temp.optPts" type="number" step="0.1" class="border rounded p-1 w-24"></label>
              <label class="grid-field"><span data-i18n="settings.general.tHeatPts">Castigo por calor</span><input data-set="base.temp.heatPenalty" type="number" step="0.1" class="border rounded p-1 w-24"></label>
            </div>
          </div>
          <div class="bg-emerald-50 rounded-lg p-4">
            <h3 class="font-bold text-emerald-800 mb-2">VPD</h3>
            <div class="grid gap-2">
              <label class="grid-field"><span data-i18n="settings.general.vpdLow">Bajo ‚â§ (kPa)</span><input data-set="base.vpd.lowThresh" type="number" step="0.1" class="border rounded p-1 w-24"></label>
              <label class="grid-field"><span data-i18n="settings.general.vpdMid">Medio ‚â§ (kPa)</span><input data-set="base.vpd.midThresh" type="number" step="0.1" class="border rounded p-1 w-24"></label>
              <label class="grid-field"><span data-i18n="settings.general.vpdHigh">Alto > (kPa)</span><input data-set="base.vpd.highThresh" type="number" step="0.1" class="border rounded p-1 w-24"></label>
              <label class="grid-field"><span data-i18n="settings.general.vpdLowPts">Puntos VPD bajo</span><input data-set="base.vpd.lowBonus" type="number" step="0.1" class="border rounded p-1 w-24"></label>
              <label class="grid-field"><span data-i18n="settings.general.vpdMidPts">Puntos VPD medio</span><input data-set="base.vpd.midBonus" type="number" step="0.1" class="border rounded p-1 w-24"></label>
              <label class="grid-field"><span data-i18n="settings.general.vpdHighPts">Castigo VPD alto</span><input data-set="base.vpd.highPenalty" type="number" step="0.1" class="border rounded p-1 w-24"></label>
            </div>
          </div>
          <div class="bg-emerald-50 rounded-lg p-4">
            <h3 class="font-bold text-emerald-800 mb-2" data-i18n="settings.general.altTitle">Altitud</h3>
            <div class="grid gap-2">
              <label class="grid-field"><span data-i18n="settings.general.lapse">Gradiente t√©rmico (¬∞C/m)</span><input data-set="base.alt.lapse" type="number" step="0.001" class="border rounded p-1 w-28"></label>
              <label class="grid-field"><span data-i18n="settings.general.refAlt">Altitud de referencia (m)</span><input data-set="base.alt.ref" type="number" step="1" class="border rounded p-1 w-28"></label>
            </div>
          </div>
        </div>

        <div class="bg-emerald-50 rounded-lg p-4">
          <h3 class="font-bold text-emerald-800 mb-2" data-i18n="settings.general.multTitle">Multiplicadores (h√°bitat / edad / suelo)</h3>
          <div class="grid md:grid-cols-3 gap-4 text-sm">
            <div>
              <p class="font-semibold mb-1" data-i18n="settings.general.hab">H√°bitat</p>
              <label class="grid-field"><span>Hayedo</span><input data-set="mult.hab.hayedo" type="number" step="0.01" class="border rounded p-1 w-20"></label>
              <label class="grid-field"><span>Robledal atl.</span><input data-set="mult.hab.robledal_atlantico" type="number" step="0.01" class="border rounded p-1 w-20"></label>
              <label class="grid-field"><span>Mixto cad.</span><input data-set="mult.hab.mixto_caducifolio" type="number" step="0.01" class="border rounded p-1 w-20"></label>
              <label class="grid-field"><span>Pinar silvestre</span><input data-set="mult.hab.pinar_silvestre" type="number" step="0.01" class="border rounded p-1 w-20"></label>
              <label class="grid-field"><span>Carrascal</span><input data-set="mult.hab.carrascal" type="number" step="0.01" class="border rounded p-1 w-20"></label>
            </div>
            <div>
              <p class="font-semibold mb-1" data-i18n="settings.general.age">Edad</p>
              <label class="grid-field"><span>Maduro</span><input data-set="mult.age.maduro" type="number" step="0.01" class="border rounded p-1 w-20"></label>
              <label class="grid-field"><span>Medio</span><input data-set="mult.age.medio" type="number" step="0.01" class="border rounded p-1 w-20"></label>
              <label class="grid-field"><span>Joven</span><input data-set="mult.age.joven" type="number" step="0.01" class="border rounded p-1 w-20"></label>
            </div>
            <div>
              <p class="font-semibold mb-1" data-i18n="settings.general.soil">Suelo</p>
              <label class="grid-field"><span>√Åcido</span><input data-set="mult.soil.acidofilo" type="number" step="0.01" class="border rounded p-1 w-20"></label>
              <label class="grid-field"><span>B√°sico</span><input data-set="mult.soil.basofilo" type="number" step="0.01" class="border rounded p-1 w-20"></label>
            </div>
          </div>
        </div>

        <div class="flex justify-end gap-2">
          <button id="reset-settings" class="px-3 py-1 rounded bg-red-100 text-red-700 text-sm" data-i18n="settings.reset">Restaurar por defecto</button>
          <button class="px-3 py-1 rounded bg-emerald-600 text-white text-sm" id="close-settings" data-i18n="settings.close">Cerrar</button>
        </div>
      </section>

      <!-- Disparadores -->
      <section id="section-triggers" class="section space-y-6">
        <div class="bg-emerald-50 rounded-lg p-4">
          <h3 class="font-bold text-emerald-800 mb-2" data-i18n="settings.trg.global">Umbrales y ventanas (globales)</h3>
          <div class="grid md:grid-cols-3 gap-4">
            <div>
              <p class="font-semibold">15 mm</p>
              <label class="grid-field"><span>Umbral (mm)</span><input data-set="triggers.mm15.th" type="number" step="1" class="border rounded p-1 w-24"></label>
              <label class="grid-field"><span>Retardo min (d)</span><input data-set="triggers.mm15.lagMin" type="number" step="1" class="border rounded p-1 w-24"></label>
              <label class="grid-field"><span>Retardo max (d)</span><input data-set="triggers.mm15.lagMax" type="number" step="1" class="border rounded p-1 w-24"></label>
            </div>
            <div>
              <p class="font-semibold">20 mm</p>
              <label class="grid-field"><span>Umbral (mm)</span><input data-set="triggers.mm20.th" type="number" step="1" class="border rounded p-1 w-24"></label>
              <label class="grid-field"><span>Retardo min (d)</span><input data-set="triggers.mm20.lagMin" type="number" step="1" class="border rounded p-1 w-24"></label>
              <label class="grid-field"><span>Retardo max (d)</span><input data-set="triggers.mm20.lagMax" type="number" step="1" class="border rounded p-1 w-24"></label>
            </div>
            <div>
              <p class="font-semibold">25 mm</p>
              <label class="grid-field"><span>Umbral (mm)</span><input data-set="triggers.mm25.th" type="number" step="1" class="border rounded p-1 w-24"></label>
              <label class="grid-field"><span>Retardo min (d)</span><input data-set="triggers.mm25.lagMin" type="number" step="1" class="border rounded p-1 w-24"></label>
              <label class="grid-field"><span>Retardo max (d)</span><input data-set="triggers.mm25.lagMax" type="number" step="1" class="border rounded p-1 w-24"></label>
            </div>
          </div>
        </div>

        <div class="bg-emerald-50 rounded-lg p-4">
          <h3 class="font-bold text-emerald-800 mb-2" data-i18n="settings.trg.species">Combinaci√≥n por especie (pesos)</h3>
          <p class="text-sm text-gray-600 mb-3" data-i18n="settings.trg.note">Cada especie suma los disparadores (15/20/25 mm) con estos pesos. En pinar los n√≠scalos reciben un impulso adicional.</p>
          <div class="grid md:grid-cols-2 gap-6">
            <div>
              <p class="font-semibold">Boletus</p>
              <label class="grid-field"><span>w15</span><input data-set="triggers.weights.boletus.w15" type="number" step="0.05" class="border rounded p-1 w-20"></label>
              <label class="grid-field"><span>w20</span><input data-set="triggers.weights.boletus.w20" type="number" step="0.05" class="border rounded p-1 w-20"></label>
              <label class="grid-field"><span>w25</span><input data-set="triggers.weights.boletus.w25" type="number" step="0.05" class="border rounded p-1 w-20"></label>
            </div>
            <div>
              <p class="font-semibold">Cantharellus</p>
              <label class="grid-field"><span>w15</span><input data-set="triggers.weights.cantharellus.w15" type="number" step="0.05" class="border rounded p-1 w-20"></label>
              <label class="grid-field"><span>w20</span><input data-set="triggers.weights.cantharellus.w20" type="number" step="0.05" class="border rounded p-1 w-20"></label>
              <label class="grid-field"><span>w25</span><input data-set="triggers.weights.cantharellus.w25" type="number" step="0.05" class="border rounded p-1 w-20"></label>
            </div>
            <div>
              <p class="font-semibold">Lactarius</p>
              <label class="grid-field"><span>w15</span><input data-set="triggers.weights.lactarius.w15" type="number" step="0.05" class="border rounded p-1 w-20"></label>
              <label class="grid-field"><span>w20</span><input data-set="triggers.weights.lactarius.w20" type="number" step="0.05" class="border rounded p-1 w-20"></label>
              <label class="grid-field"><span>w25</span><input data-set="triggers.weights.lactarius.w25" type="number" step="0.05" class="border rounded p-1 w-20"></label>
              <label class="grid-field"><span data-i18n="settings.trg.pineBoost">Impulso en pinar</span><input data-set="triggers.weights.lactarius.pineBoost" type="number" step="0.01" class="border rounded p-1 w-20"></label>
            </div>
            <div>
              <p class="font-semibold">Lepista nuda</p>
              <label class="grid-field"><span>w15</span><input data-set="triggers.weights.lepista_nuda.w15" type="number" step="0.05" class="border rounded p-1 w-20"></label>
              <label class="grid-field"><span>w20</span><input data-set="triggers.weights.lepista_nuda.w20" type="number" step="0.05" class="border rounded p-1 w-20"></label>
              <label class="grid-field"><span>w25</span><input data-set="triggers.weights.lepista_nuda.w25" type="number" step="0.05" class="border rounded p-1 w-20"></label>
            </div>
            <div>
              <p class="font-semibold">Hydnum repandum</p>
              <label class="grid-field"><span>w15</span><input data-set="triggers.weights.hydnum_repandum.w15" type="number" step="0.05" class="border rounded p-1 w-20"></label>
              <label class="grid-field"><span>w20</span><input data-set="triggers.weights.hydnum_repandum.w20" type="number" step="0.05" class="border rounded p-1 w-20"></label>
              <label class="grid-field"><span>w25</span><input data-set="triggers.weights.hydnum_repandum.w25" type="number" step="0.05" class="border rounded p-1 w-20"></label>
            </div>
          </div>
        </div>

        <div class="flex justify-end gap-2">
          <button id="reset-triggers" class="px-3 py-1 rounded bg-red-100 text-red-700 text-sm" data-i18n="settings.reset">Restaurar por defecto</button>
          <button class="px-3 py-1 rounded bg-emerald-600 text-white text-sm" id="close-settings-2" data-i18n="settings.close">Cerrar</button>
        </div>
      </section>

      <!-- Especies -->
      <section id="section-species" class="section space-y-6">
        <div class="bg-emerald-50 rounded-lg p-4">
          <h3 class="font-bold text-emerald-800 mb-2" data-i18n="settings.sp.ranges">Rangos por especie</h3>
          <div class="grid md:grid-cols-2 gap-6 text-sm">
            <!-- Template block function will fill -->
            <div id="species-forms" class="grid md:grid-cols-2 gap-6"></div>
          </div>
        </div>
        <div class="flex justify-end gap-2">
          <button id="reset-species" class="px-3 py-1 rounded bg-red-100 text-red-700 text-sm" data-i18n="settings.reset">Restaurar por defecto</button>
          <button class="px-3 py-1 rounded bg-emerald-600 text-white text-sm" id="close-settings-3" data-i18n="settings.close">Cerrar</button>
        </div>
      </section>
    </div>
  </div>

<script>
/******************** I18N ********************/  
const I18N = {
  es: {
    subtitle: "Probabilidad general y especies m√°s probables seg√∫n condiciones.",
    add: { title:"A√±adir nueva ubicaci√≥n", placeholder:"Escribe el lugar (ej. Aralar, Navarra)", search:"Buscar", habitatSummary:"Opciones de h√°bitat (opcional)", habitatType:"Tipo de h√°bitat", age:"Edad del arbolado", soil:"Suelo", addBtn:"A√±adir a Mis Lugares", resultsProvince:"Provincia", resultsMunicipality:"Municipio", resultsCountry:"Pa√≠s", resultsCoords:"Coordenadas" },
    moon: { title:"Fase lunar", next:"Pr√≥xima luna llena: " },
    parks: { title:"Parques Micol√≥gicos", desc:"Consulta la web de:" },
    controls: { filterBy:"Filtrar por:", all:"Todas", high:"Alta", mid:"Media", low:"Baja", sortBy:"Ordenar por:", name:"Nombre", chance:"Probabilidad" },
    loading: "Cargando predicciones... ",
    welcome: { title:"¬°Bienvenido/a!", text:"Empieza a planificar tu pr√≥xima salida al monte a√±adiendo tus lugares favoritos con el buscador de arriba. Las ubicaciones que a√±adas se guardar√°n autom√°ticamente en tu navegador." },
    forecast7: "Previsi√≥n para 7 d√≠as:",
    speciesTitle: "Predicci√≥n por especie",
    temp: "Temp. (¬∞C)", rain:"Lluvia (mm)", et:"ET (mm)",
    score: "Puntuaci√≥n",
    chanceMap: { Alta:"Alta", Media:"Media", Baja:"Baja" },
    help: { title:"Acerca de esta aplicaci√≥n", p1:"Esta aplicaci√≥n estima la probabilidad de encontrar setas combinando condiciones meteorol√≥gicas recientes y un modelo heur√≠stico ajustado a h√°bitats t√≠picos del norte de Navarra.", how:"¬øC√≥mo se calcula la probabilidad?", list:["SMI (humedad de suelo) depende del tipo de suelo: √°cido‚âà90, b√°sico‚âà70.","Disparadores post-lluvia por especie/h√°bitat (15/20/25 mm y ventanas 4‚Äì12 d√≠as).","Temperatura efectiva: media 3 d√≠as + correcci√≥n por altitud (‚àí0,006 ¬∞C/m).","VPD (d√©ficit de presi√≥n de vapor) mejor que solo HR.","Penalizaciones: calor sostenido, viento+calor, heladas recientes.","Estacionalidad por quincena y peque√±os ajustes por h√°bitat/edad/suelo."], speciesMode:"Modo especie", speciesList:["Boletus, Cantharellus, N√≠scalos (Lactarius), Lepista nuda y Hydnum repandum con pesos espec√≠ficos.","Gr√°fico: barras apiladas por especie + l√≠nea de probabilidad base.","La especie m√°s favorecida por d√≠a se marca como chip."], footer:"Recolecta con respeto y jam√°s consumas sin identificaci√≥n total. Esta herramienta es orientativa. Autor√≠a: Amilibia + Experto en Micolog√≠a." },
    chart: { histTitle:"Hist√≥rico 7 d√≠as", temp:"Temp. media (¬∞C)", rain:"Lluvia (mm)", et0:"ET0 (mm)", smi:"SMI (%)" },
    settings: {
      title:"Ajustes del modelo",
      tabs: { general:"General", triggers:"Disparadores", species:"Especies" },
      reset:"Restaurar por defecto", close:"Cerrar",
      general: { smiTitle:"Humedad de suelo (SMI)", smaxAcid:"Smax suelo √°cido", smaxBasic:"Smax suelo b√°sico", smaxDefault:"Smax por defecto", tempTitle:"Temperatura (probabilidad base)", tOpt:"√ìptimo (min‚Äëmax ¬∞C)", tHeatTh:"Castigo calor si T> (¬∞C)", tOptPts:"Puntos por √≥ptimo", tHeatPts:"Castigo por calor", altTitle:"Altitud", lapse:"Gradiente t√©rmico (¬∞C/m)", refAlt:"Altitud de referencia (m)", multTitle:"Multiplicadores (h√°bitat / edad / suelo)", hab:"H√°bitat", age:"Edad", soil:"Suelo" },
      trg: { global:"Umbrales y ventanas (globales)", species:"Combinaci√≥n por especie (pesos)", pineBoost:"Impulso en pinar", note:"Cada especie suma los disparadores (15/20/25 mm) con estos pesos. En pinar los n√≠scalos reciben un impulso adicional." },
      sp: { ranges:"Rangos por especie", temp:"Temp. √≥ptima (min‚Äëmax ¬∞C)", smi:"SMI c√≥modo (lo‚Äëhi)", season:"Estacionalidad (¬µ, œÉ)", season2:"2¬∫ pico (¬µ2, œÉ2)", label:"Etiqueta" }
    }
  },
  eu: {
    subtitle: "Baldintzen arabera aukera orokorra eta ustezko espezieak.",
    add: { title:"Kokapen berria gehitu", placeholder:"Idatzi lekua (adib. Aralar, Nafarroa)", search:"Bilatu", habitatSummary:"Habitat aukerak (aukerakoa)", habitatType:"Habitat mota", age:"Basogintzaren adina", soil:"Lurra", addBtn:"Gehitu Nire Lekuetara", resultsProvince:"Probintzia", resultsMunicipality:"Udala", resultsCountry:"Herrialdea", resultsCoords:"Koordenadak" },
    moon: { title:"Ilargiaren fasea", next:"Hurrengo ilargi betea: " },
    parks: { title:"Parke Mikologikoak", desc:"Webgunea kontsultatu:" },
    controls: { filterBy:"Iragazi honen arabera:", all:"Guztiak", high:"Handia", mid:"Ertaina", low:"Txikia", sortBy:"Ordenatu honen arabera:", name:"Izena", chance:"Aukera" },
    loading: "Aurreikuspenak kargatzen... ",
    welcome: { title:"Ongi etorri!", text:"Hasi mendira irteera planifikatzen goiko bilatzailea erabiliz zure leku gogokoenak gehituz. Gehituriko kokapenak zure nabigatzailean gordeko dira." },
    forecast7: "7 egunetarako aurreikuspena:",
    speciesTitle: "Espezieen iragarpena",
    temp: "Tenp. (¬∞C)", rain:"Euria (mm)", et:"ET (mm)",
    score: "Puntuazioa",
    chanceMap: { Alta:"Handia", Media:"Ertaina", Baja:"Txikia" },
    help: { title:"Aplikazio honi buruz", p1:"Aplikazio honek onddoak aurkitzeko probabilitatea estimatzen du, azken eguraldi baldintzak eta Nafarroa iparraldeko habitatetara doitutako eredu heuristiko bat konbinatuta.", how:"Nola kalkulatzen da probabilitatea?", list:["SMI (lur hezetasuna) lur motaren arabera: azidoa‚âà90, oinarri-koa‚âà70.","Euri ondoko abiarazleak espezie/habitataren arabera (15/20/25 mm eta 4‚Äì12 egun).","Tenperatura eraginkorra: 3 egunen batezbestekoa + altitude-doikuntza (‚àí0,006 ¬∞C/m).","VPD (lurrun-presioaren defizita) HR soilik baino fidagarriagoa.","Zigor-faktoreak: bero jarraitua, haizea+bero, azken izozteak.","Hamabostaldika estazionaltasuna eta doikuntzak habitat/adina/lurraren arabera."], speciesMode:"Espezie modua", speciesList:["Boletus, Cantharellus, Niskaloak (Lactarius), Lepista nuda eta Hydnum repandum pisu espezifikoekin.","Grafikoa: espezieka pilatutako barrak + oinarri‚Äëprob. lerroa.","Eguneko espezie onena chip gisa markatzen da."], footer:"Bildu errespetuz eta inoiz ez kontsumitu identifikazio osoa gabe. Tresna hau orientagarria da. Egiletza: Amilibia + Mikologiako aditua." },
    chart: { histTitle:"Historiala 7 egun", temp:"Batezbest. tenp. (¬∞C)", rain:"Euria (mm)", et0:"ET0 (mm)", smi:"SMI (%)" },
    settings: {
      title:"Ereduaren ezarpenak",
      tabs: { general:"Orokorra", triggers:"Abiarazleak", species:"Espezieak" },
      reset:"Lehenetsietara itzuli", close:"Itxi",
      general: { smiTitle:"Lurzoruaren hezetasuna (SMI)", smaxAcid:"Smax lur azidoa", smaxBasic:"Smax lur oinarrizkoa", smaxDefault:"Smax lehenetsia", tempTitle:"Tenperatura (prob. oinarria)", tOpt:"Optimoa (min‚Äëmax ¬∞C)", tHeatTh:"Zigorra beroa T> (¬∞C)", tOptPts:"Puntuak optimumean", tHeatPts:"Zigorra beroagatik", altTitle:"Altuera", lapse:"Tenp. gradientea (¬∞C/m)", refAlt:"Erreferentzia‚Äëaltuera (m)", multTitle:"Biderkatzaileak (habitat / adina / lurra)", hab:"Habitat", age:"Adina", soil:"Lurra" },
      trg: { global:"Atalaseak eta leihoak (orokorrak)", species:"Espezieren arabera (pisuak)", pineBoost:"Bultzada pinarrean", note:"Espezie bakoitzak 15/20/25 mm abiarazleak pisu hauekin batzen ditu. Pinarrean niskaloek aparteko bultzada dute." },
      sp: { ranges:"Espezieen tarteak", temp:"Tenp. optimoa (min‚Äëmax ¬∞C)", smi:"SMI egokia (lo‚Äëhi)", season:"Estazionaltasuna (¬µ, œÉ)", season2:"2. gailurra (¬µ2, œÉ2)", label:"Etiketa" }
    }
  }
};

const getLang = ()=> localStorage.getItem('app_lang')||'es';
const setLang = (v)=>{ const val=(v==='eu')?'eu':'es'; localStorage.setItem('app_lang',val); document.documentElement.setAttribute('data-lang',val); return val; };
const isEU = ()=> getLang()==='eu';
function t(path){ const lang=getLang(); const parts=path.split('.'); let node=I18N[lang]; for(const p of parts){ node=node?.[p]; if(node===undefined) return path; } return (typeof node==='function')?node():node; }
function applyStaticI18N(){ const lang=getLang(); document.querySelectorAll('[data-i18n]').forEach(el=>{ const k=el.getAttribute('data-i18n'); const v=t(k); if(v!=null) el.textContent=v; }); document.querySelectorAll('[data-i18n-ph]').forEach(el=>{ const k=el.getAttribute('data-i18n-ph'); const v=t(k); if(v!=null) el.setAttribute('placeholder', v); }); const b=document.getElementById('__langBtn'); if(b) b.textContent=(lang==='eu')?'Castellano':'Euskara'; fillSettingsI18N(); }

/******************** Formateo fechas ********************/
const WEEKDAY_SHORT={ es:['dom','lun','mar','mi√©','jue','vie','s√°b'], eu:['ig.','al.','ar.','az.','og.','ol.','lr.'] };
const MONTH_SHORT={ es:['ene','feb','mar','abr','may','jun','jul','ago','sep','oct','nov','dic'], eu:['urt','ots','mar','api','mai','eka','uzt','abu','ira','urr','aza','abe'] };
const MONTH_LONG={ es:['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'], eu:['urtarrila','otsaila','martxoa','apirila','maiatza','ekaina','uztaila','abuztua','iraila','urria','azaroa','abendua'] };
function fmtWeekdayDayMonthShort(dateLike, lang){ const d=(dateLike instanceof Date)?dateLike:new Date(dateLike); return `${WEEKDAY_SHORT[lang][d.getDay()]} ${d.getDate()} ${MONTH_SHORT[lang][d.getMonth()]}`; }
function fmtDayMonthShort(dateLike, lang){ const d=(dateLike instanceof Date)?dateLike:new Date(dateLike); return `${d.getDate()} ${MONTH_SHORT[lang][d.getMonth()]}`; }
function fmtDayMonthLong(dateLike, lang){ const d=(dateLike instanceof Date)?dateLike:new Date(dateLike); return (lang==='eu')? `${MONTH_LONG.eu[d.getMonth()]}ren ${d.getDate()}a` : `${d.getDate()} de ${MONTH_LONG.es[d.getMonth()]}`; }

/******************** Selects opciones ********************/
const HABITATS=[['','(sin especificar)'],['hayedo','Hayedo'],['robledal_atlantico','Robledal atl√°ntico'],['pinar_silvestre','Pinar de pino silvestre'],['carrascal','Carrascal'],['mixto_caducifolio','Mixto caducifolio']];
const HABITATS_EU=[['','(zehaztu gabe)'],['hayedo','Pago‚Äëbasoa'],['robledal_atlantico','Harizti atlantikoa'],['pinar_silvestre','Pinu gorria (pinar)'],['carrascal','Arte‚Äësasia'],['mixto_caducifolio','Hostoerorkor nahasia']];
const AGES=[['','(sin especificar)'],['maduro','Maduro (>80)'],['medio','Medio (40‚Äì80)'],['joven','Joven (<40)']];
const AGES_EU=[['','(zehaztu gabe)'],['maduro','Zaharra (>80)'],['medio','Ertaina (40‚Äì80)'],['joven','Gaztea (<40)']];
const SOILS=[['','(sin especificar)'],['acidofilo','√Åcido'],['basofilo','B√°sico']];
const SOILS_EU=[['','(zehaztu gabe)'],['acidofilo','Azidoa'],['basofilo','Oinarrizkoa']];
function fillSelectOptions(){ const lang=getLang(); const fill=(sel,arr)=>{ if(!sel) return; const keep=sel.value; sel.innerHTML=arr.map(([v,l])=>`<option value="${v}">${l}</option>`).join(''); if(arr.some(([v])=>v===keep)) sel.value=keep; else sel.selectedIndex=0; }; fill(document.getElementById('habitat-select'), lang==='eu'?HABITATS_EU:HABITATS); fill(document.getElementById('age-select'), lang==='eu'?AGES_EU:AGES); fill(document.getElementById('soil-select'), lang==='eu'?SOILS_EU:SOILS); }

/******************** Notificaciones ********************/
function showNotification(message,type='info'){ const n=document.getElementById('notification'); n.textContent=message; n.className=`max-w-6xl mx-auto mb-4 p-4 rounded-md text-sm ${type==='error'?'bg-red-100 text-red-800':(type==='warning'?'bg-yellow-100 text-yellow-800':'bg-blue-100 text-blue-800')}`; n.classList.remove('hidden'); setTimeout(()=>n.classList.add('hidden'), 3200); }

/******************** APIs ********************/
const OPENMETEO_API_URL="https://api.open-meteo.com/v1/forecast";
const NOMINATIM_API_URL="https://nominatim.openstreetmap.org/search";
async function fetchAltitude(lat,lon,{timeout=2500}={}){ const key=`alt:${lat.toFixed(5)},${lon.toFixed(5)}`; const c=localStorage.getItem(key); if(c!==null) return Number(c); try{ const ctrl=new AbortController(); const t=setTimeout(()=>ctrl.abort(),timeout); const r=await fetch(`https://api.open-meteo.com/v1/elevation?latitude=${lat}&longitude=${lon}`,{signal:ctrl.signal,cache:'no-store'}); clearTimeout(t); const j=await r.json(); const h=j?.elevation?.[0]; if(Number.isFinite(h)){ localStorage.setItem(key,String(h)); return h; } }catch(_){} return null; }

/******************** Defaults Navarra ********************/
const NAVARRA_BBOX={ minLon:-2.5, maxLon:-0.7, minLat:41.8, maxLat:43.4 };
const DEFAULT_LOCATIONS=[ { name:"Ultzama", lat:43.00952, lon:-1.68460, habitat:"hayedo", ageClass:"maduro", soilAcidity:"acidofilo" }, { name:"Selva Irati", lat:42.97500, lon:-1.11800, habitat:"hayedo", ageClass:"maduro", soilAcidity:"acidofilo" }, { name:"Altsasu", lat:42.90780, lon:-2.17060, habitat:"hayedo", ageClass:"maduro", soilAcidity:"acidofilo" } ];
let LOCATIONS=[]; let currentFilter='all'; let currentSort='name'; let allForecastData=[];

/******************** Tiempo y utilidades ********************/
const WEATHER_ICONS={0:'‚òÄÔ∏è',1:'üå§Ô∏è',2:'‚õÖ',3:'‚òÅÔ∏è',45:'üå´Ô∏è',48:'üå´Ô∏è',51:'üåßÔ∏è',53:'üåßÔ∏è',55:'üåßÔ∏è',56:'üåßÔ∏è',57:'üåßÔ∏è',61:'üå¶Ô∏è',63:'üåßÔ∏è',65:'‚õàÔ∏è',66:'üå®Ô∏è',67:'üå®Ô∏è',71:'üå®Ô∏è',73:'üå®Ô∏è',75:'üå®Ô∏è',77:'üå®Ô∏è',80:'üåßÔ∏è',81:'üåßÔ∏è',82:'‚õàÔ∏è',85:'üå®Ô∏è',86:'üå®Ô∏è',95:'üå©Ô∏è',96:'‚õàÔ∏è',99:'‚õàÔ∏è',default:'‚ùì'};
const clamp=(x,lo,hi)=>Math.max(lo,Math.min(hi,x));
function getWeatherIcon(code){ return WEATHER_ICONS[code]||WEATHER_ICONS.default; }
function todayLocalYYYYMMDD(){ const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,10); }
function movingAvg(a,k=3){ const n=a.length,out=new Array(n).fill(0); for(let i=0;i<n;i++){ let s=0,c=0; for(let j=0;j<k;j++){ const idx=i-j; if(idx>=0){ s+=a[idx]; c++; } } out[i]=s/Math.max(1,c);} return out; }
function vpdFromTempRH(T,RH){ const es=0.6108*Math.exp((17.27*T)/(T+237.3)); return es*(1-(RH||0)/100); }

async function fetchWeather(lat,lon,pastDays=14,forecastDays=7){ const cacheKey=`weather_${lat}_${lon}_${pastDays}_${forecastDays}`; const cached=localStorage.getItem(cacheKey); const time=localStorage.getItem(`${cacheKey}_time`); const lang=getLang(); if(cached && time && (Date.now()-parseInt(time))<6*3600*1000){ showNotification(I18N[lang].loading.replace('Cargando','Usando cache'), 'info'); return JSON.parse(cached);} if(!navigator.onLine){ if(cached){ showNotification(lang==='eu'?'Cacheko datuak erabiltzen.':'Usando datos cacheados.', 'info'); return JSON.parse(cached);} showNotification(lang==='eu'?'Ez dago internetik.':'Sin conexi√≥n a internet.', 'error'); throw new Error('Offline'); } const url=`${OPENMETEO_API_URL}?latitude=${lat}&longitude=${lon}&past_days=${pastDays}&forecast_days=${forecastDays}&hourly=temperature_2m,relative_humidity_2m,precipitation,dew_point_2m,weather_code,wind_speed_10m,et0_fao_evapotranspiration&timezone=Europe%2FMadrid`; const r=await fetch(url); const data=await r.json(); localStorage.setItem(cacheKey, JSON.stringify(data)); localStorage.setItem(`${cacheKey}_time`, Date.now().toString()); return data; }

function processDailyData(data){ const days={}; data.hourly.time.forEach((time,i)=>{ const date=new Date(time).toISOString().split('T')[0]; if(!days[date]) days[date]={ temps:[], rain_for_day:0, humidities:[], dew_points:[], wind_speeds:[], temp_max:-Infinity, et0:[] }; days[date].temps.push(data.hourly.temperature_2m[i]); days[date].humidities.push(data.hourly.relative_humidity_2m[i]); days[date].dew_points.push(data.hourly.dew_point_2m[i]); days[date].rain_for_day += data.hourly.precipitation[i]||0; days[date].wind_speeds.push(data.hourly.wind_speed_10m[i]); days[date].et0.push(data.hourly.et0_fao_evapotranspiration[i]||0); if(data.hourly.temperature_2m[i]>days[date].temp_max) days[date].temp_max=data.hourly.temperature_2m[i]; }); return Object.entries(days).map(([date,v])=>({ date, temps:v.temps, rain_for_day:v.rain_for_day, humidities:v.humidities, dew_points:v.dew_points, wind_speeds:v.wind_speeds, et0:v.et0, temp_min:Math.min(...v.temps), temp_max:v.temp_max, avg_temp:v.temps.reduce((a,b)=>a+b,0)/v.temps.length||0, avg_humidity:v.humidities.reduce((a,b)=>a+b,0)/v.humidities.length||0, avg_dew_point:v.dew_points.reduce((a,b)=>a+b,0)/v.dew_points.length||0, avg_wind_speed:v.wind_speeds.reduce((a,b)=>a+b,0)/v.wind_speeds.length||0, avg_et0:v.et0.reduce((a,b)=>a+b,0)/v.et0.length||0 })); }

/******************** AJUSTES (SETTINGS) ********************/
const DEFAULT_SETTINGS = {
  smi: { smax: { acid:90, basic:70, default:80 } },
  base: {
    temp: { optMin:8, optMax:18, heatThresh:24, optPts:1.4, heatPenalty:-1.0 },
    vpd:  { lowThresh:0.6, midThresh:1.2, highThresh:2.0, lowBonus:1.0, midBonus:0.5, highPenalty:-0.8 },
    alt:  { lapse:0.006, ref:600 }
  },
  mult: {
    hab: { hayedo:1.15, robledal_atlantico:1.10, mixto_caducifolio:1.08, pinar_silvestre:1.00, carrascal:0.85 },
    age: { maduro:1.10, medio:1.00, joven:0.90 },
    soil:{ acidofilo:1.10, basofilo:1.00 }
  },
  triggers: {
    mm15:{ th:15, lagMin:4, lagMax:10 },
    mm20:{ th:20, lagMin:5, lagMax:12 },
    mm25:{ th:25, lagMin:6, lagMax:12 },
    weights:{
      boletus:{ w15:0.2, w20:0.5, w25:0.8 },
      cantharellus:{ w15:0.6, w20:0.5, w25:0.3 },
      lactarius:{ w15:0.7, w20:0.5, w25:0.3, pineBoost:1.10 },
      lepista_nuda:{ w15:0.5, w20:0.6, w25:0.4 },
      hydnum_repandum:{ w15:0.5, w20:0.6, w25:0.4 }
    }
  },
  species: {
    boletus:{ label:'Boletus gr. edulis', temp:{min:10,max:18}, smi:{lo:0.55,hi:0.75}, season:{ mu:285, sigma:18, mu2:250, sigma2:22 } },
    cantharellus:{ label:'Cantharellus cibarius', temp:{min:8,max:20}, smi:{lo:0.60,hi:0.85}, season:{ mu:240, sigma:40 } },
    lactarius:{ label:'N√≠scalos (Lactarius gr. deliciosus)', temp:{min:9,max:16}, smi:{lo:0.50,hi:0.70}, season:{ mu:300, sigma:20 } },
    lepista_nuda:{ label:'Lepista nuda (pie azul)', temp:{min:4,max:12}, smi:{lo:0.60,hi:0.80}, season:{ mu:320, sigma:25 } },
    hydnum_repandum:{ label:'Hydnum repandum (lengua de vaca)', temp:{min:6,max:15}, smi:{lo:0.60,hi:0.80}, season:{ mu:295, sigma:20 } }
  }
};
// === Extensi√≥n: especies extra (gu√≠a + predicci√≥n) ===
const EXTRA_SPECIES = {
  russula_cyanoxantha:{ label:'Russula cyanoxantha (carbonera)', temp:{min:8,max:18}, smi:{lo:0.50,hi:0.80}, season:{ mu:290, sigma:25 } },
  craterellus_cornucopioides:{ label:'Craterellus cornucopioides (trompeta negra)', temp:{min:7,max:15}, smi:{lo:0.60,hi:0.85}, season:{ mu:305, sigma:25 } },
  craterellus_tubaeformis:{ label:'Craterellus tubaeformis (angula de monte)', temp:{min:4,max:12}, smi:{lo:0.70,hi:0.90}, season:{ mu:320, sigma:25 } },
  hygrophorus_latitabundus:{ label:'Hygrophorus latitabundus (ilarraka)', temp:{min:6,max:12}, smi:{lo:0.55,hi:0.80}, season:{ mu:300, sigma:20 } }
};
const EXTRA_WEIGHTS = {
  russula_cyanoxantha:{ w15:0.6, w20:0.5, w25:0.3 },
  craterellus_cornucopioides:{ w15:0.5, w20:0.6, w25:0.4 },
  craterellus_tubaeformis:{ w15:0.6, w20:0.5, w25:0.3 },
  hygrophorus_latitabundus:{ w15:0.6, w20:0.5, w25:0.3 }
};
const EXTRA_META = {
  russula_cyanoxantha:{ color:'#0ea5e9', light:'#e0f2fe' },
  craterellus_cornucopioides:{ color:'#111827', light:'#e5e7eb' },
  craterellus_tubaeformis:{ color:'#d97706', light:'#ffedd5' },
  hygrophorus_latitabundus:{ color:'#16a34a', light:'#dcfce7' }
};
Object.assign(DEFAULT_SETTINGS.species, EXTRA_SPECIES);
Object.assign(DEFAULT_SETTINGS.triggers.weights, EXTRA_WEIGHTS);

const LS_SETTINGS_KEY='mushSettings_v1';
function deepClone(o){ return JSON.parse(JSON.stringify(o)); }
function loadSettings(){ try{ const j=JSON.parse(localStorage.getItem(LS_SETTINGS_KEY)||'null'); if(!j) return deepClone(DEFAULT_SETTINGS); return Object.assign({}, deepClone(DEFAULT_SETTINGS), j); }catch{ return deepClone(DEFAULT_SETTINGS);} }
function saveSettings(){ localStorage.setItem(LS_SETTINGS_KEY, JSON.stringify(SETTINGS)); }
let SETTINGS = loadSettings();

/******************** Modelo *****************************/
function computeSoilMoistureIndex(rain,et0,Smax){ let S=Smax*0.5; const out=[]; for(let i=0;i<rain.length;i++){ const eff=Math.min(rain[i]||0,25)*0.8; const e=Math.max(et0[i]||0,0); S=clamp(S+eff-e, 0, Smax); out.push(S/Smax);} return out; }
function computePulseGaussian(rain, windowDays, threshold, lagMin, lagMax){ const n=rain.length, trig=new Array(n).fill(0); let last=-Infinity; for(let i=0;i<n;i++){ const sum=rain.slice(Math.max(0,i-windowDays+1), i+1).reduce((a,b)=>a+(b||0),0); if(sum>=threshold) last=i; const d=i-last; if(d>=lagMin && d<=lagMax){ const mid=(lagMin+lagMax)/2, sigma=(lagMax-lagMin)/4; trig[i]=Math.exp(-0.5*Math.pow((d-mid)/sigma,2)); } } return trig; }
function doy(dateLike){ const d=(dateLike instanceof Date)?dateLike:new Date(dateLike); const start=new Date(d.getFullYear(),0,0); return Math.floor((d-start)/86400000); }
function gauss(x,mu,s){ const z=(x-mu)/s; return Math.exp(-0.5*z*z); }
function triangleSuitability(x,[min,max]){ if(x<=min||x>=max) return 0; const mid=(min+max)/2; return x<=mid ? (x-min)/(mid-min) : (max-x)/(max-mid); }
function smiSuitability(s,[lo,hi]){ if(s<=lo) return s/lo*0.6; if(s>=hi) return 1; const r=(s-lo)/(hi-lo); return 0.6+0.4*r; }

function seasonWeight(d, spKey){ const x=doy(d); const s=SETTINGS.species[spKey].season; const w1=gauss(x, s.mu, s.sigma); const w2=(s.mu2 && s.sigma2)? gauss(x, s.mu2, s.sigma2) : 0; return Math.max(0.2, Math.max(w1, w2)); }

function computeBaseProbabilities(dailyData, location){
  const smax = location.soilAcidity==='acidofilo'? SETTINGS.smi.smax.acid : (location.soilAcidity==='basofilo'? SETTINGS.smi.smax.basic : SETTINGS.smi.smax.default);
  const rain=dailyData.map(d=>d.rain_for_day||0), et0=dailyData.map(d=>d.avg_et0||0), tmed=dailyData.map(d=>(d.temp_min+d.temp_max)/2), rh=dailyData.map(d=>d.avg_humidity||0), wind=dailyData.map(d=>d.avg_wind_speed||0);
  const alt = Number.isFinite(location.altitude)? location.altitude : SETTINGS.base.alt.ref;
  const tCorr = tmed.map(T=> T - SETTINGS.base.alt.lapse*(alt - SETTINGS.base.alt.ref));
  const tCorr3 = movingAvg(tCorr,3);
  const smi = computeSoilMoistureIndex(rain, et0, smax);
  const vpd = tCorr.map((T,i)=> vpdFromTempRH(T, rh[i]));
  const g=SETTINGS.base; const mult=SETTINGS.mult;
  const trig15 = computePulseGaussian(rain,2, SETTINGS.triggers.mm15.th, SETTINGS.triggers.mm15.lagMin, SETTINGS.triggers.mm15.lagMax);
  const trig20 = computePulseGaussian(rain,2, SETTINGS.triggers.mm20.th, SETTINGS.triggers.mm20.lagMin, SETTINGS.triggers.mm20.lagMax);
  const results=dailyData.map((d,i)=>{
    let sc=0; const bd=[]; // breakdown
    if(smi[i]>=0.7){ sc+=2.5; bd.push('Suelo h√∫medo (SMI ‚â• 0.7) (+2.5)'); }
    else if(smi[i]>=0.5){ sc+=1.5; bd.push('Suelo con humedad media (SMI ‚â• 0.5) (+1.5)'); }
    else if(smi[i]>0.3){ sc+=0.5; bd.push('Suelo algo seco (SMI > 0.3) (+0.5)'); }
    else { bd.push('Suelo seco (SMI ‚â§ 0.3)'); }

    if(trig20[i]>0){ const add=0.8*trig20[i]; sc+=add; bd.push(`Brote tras lluvia reciente (+${add.toFixed(1)})`); }

    const T=tCorr3[i];
    if(T>=g.temp.optMin && T<=g.temp.optMax){ sc+=g.temp.optPts; bd.push(`Temp. √≥ptima (${g.temp.optMin}-${g.temp.optMax}¬∞C) (+${g.temp.optPts})`); }
    else if(T>g.temp.heatThresh){ sc+=g.temp.heatPenalty; bd.push(`Calor alto (>${g.temp.heatThresh}¬∞C) (${g.temp.heatPenalty})`); }

    const v=vpd[i];
    if(v<=g.vpd.lowThresh){ sc+=g.vpd.lowBonus; bd.push(`VPD bajo (+${g.vpd.lowBonus})`); }
    else if(v<=g.vpd.midThresh){ sc+=g.vpd.midBonus; bd.push(`VPD medio (+${g.vpd.midBonus})`); }
    else if(v>g.vpd.highThresh){ sc+=g.vpd.highPenalty; bd.push(`VPD alto (${g.vpd.highPenalty})`); }

    const avg3Wind = i>=2?(wind[i]+wind[i-1]+wind[i-2])/3:wind[i];
    const avg3Temp = i>=2?(tCorr[i]+tCorr[i-1]+tCorr[i-2])/3:tCorr[i];
    if(avg3Wind>20 && avg3Temp>20){ sc-=1.2; bd.push('Viento+calor (‚àí1.2)'); }

    const last7=dailyData.slice(Math.max(0,i-6),i+1); const frost=last7.filter(x=>x.temp_min<=-2).length; if(frost>=2){ sc-=1.3; bd.push('Heladas recientes (‚àí1.3)'); }

    if(alt>1000){ sc-=0.3; bd.push('Alta monta√±a (>1000 m, retraso temporada) (‚àí0.3)'); }
    if(alt<800 && new Date(d.date).getMonth()<8){ sc-=0.8; bd.push('Zona baja y temporada temprana (‚àí0.8)'); }

    let m=1.0; if(location.habitat) m*=(mult.hab[location.habitat]||1.0); if(location.ageClass) m*=(mult.age[location.ageClass]||1.0); if(location.soilAcidity) m*=(mult.soil[location.soilAcidity]||1.0); if(m!==1.0) bd.push(`Factor de h√°bitat √ó${m.toFixed(2)}`); sc*=m;

    const p = 1/(1+Math.exp(-(sc-5.0)))*100; const chance = p>=75?'Alta':(p>=50?'Media':'Baja');
    return { ...d, smi:smi[i], vpd:v, tmed:T, baseProb:clamp(p,0,100), score:`${p.toFixed(1)}%`, chance, _aux:{tCorr3:tCorr3[i]} , score_breakdown:bd };
  });
  return { series:{tCorr3, smi, vpd, trig15, trig20}, daily:results };
}

function speciesPulseWeight(i, speciesKey, habitat, smiVal, ctx){ const W=SETTINGS.triggers.weights[speciesKey]; const trig15=ctx.trig15[i]||0, trig20=ctx.trig20[i]||0; const trig25=computePulseGaussian(ctx.rain||[],2, SETTINGS.triggers.mm25.th, SETTINGS.triggers.mm25.lagMin, SETTINGS.triggers.mm25.lagMax)[i]||0; let base = W.w15*trig15 + W.w20*trig20 + W.w25*trig25; if(speciesKey==='lactarius' && habitat==='pinar_silvestre') base*= (W.pineBoost||1.0); if(speciesKey==='cantharellus' && smiVal>=0.6) base = Math.max(base, trig15); return clamp(base,0,1); }

const SPECIES_META = { boletus:{ color:'#047857', light:'#D1FAE5' }, cantharellus:{ color:'#CA8A04', light:'#FEF3C7' }, lactarius:{ color:'#B91C1C', light:'#FEE2E2' }, lepista_nuda:{ color:'#6D28D9', light:'#EDE9FE' }, hydnum_repandum:{ color:'#9A3412', light:'#FFEDD5' } };
// a√±adir paleta extra
Object.assign(SPECIES_META, EXTRA_META);

function computeSpeciesForLocation(location, baseCtx){ const dd = baseCtx.daily; const rain = dd.map(d=>d.rain_for_day||0); const ctx = { ...baseCtx.series, rain };
  location.forecast = dd.map((d,i)=>{ const out={...d}; const spProbs={}; let sum=0; for(const key of Object.keys(SETTINGS.species)){ const spS=SETTINGS.species[key]; const wT=Math.pow(triangleSuitability(d.tmed, [spS.temp.min, spS.temp.max]), 1.15); const wSmi=Math.pow(smiSuitability(d.smi, [spS.smi.lo, spS.smi.hi]), 1.1); const wPulse=speciesPulseWeight(i, key, location.habitat||'', d.smi, ctx); const wSeason=seasonWeight(d.date, key); const wHab=(key==='lactarius' && (location.habitat||'')==='pinar_silvestre') ? 1.10 : 1.0; const raw=wT*wSmi*(0.5+0.5*wPulse)*wSeason*wHab; spProbs[key]=raw; sum+=raw; } if(sum<=0) sum=1e-6; const scaled={}; for(const k of Object.keys(spProbs)){ scaled[k]=(spProbs[k]/sum)*d.baseProb; } out.species=scaled; out.top_species=Object.keys(scaled).sort((a,b)=>scaled[b]-scaled[a])[0]||null; return out; }); return location; }

/******************** Pipeline ********************/
async function updateLocationData(location){ try{ const weatherData=await fetchWeather(location.lat, location.lon, 14, 7); const altitude=await fetchAltitude(location.lat, location.lon); const dailyData=processDailyData(weatherData); location.altitude=altitude; const base=computeBaseProbabilities(dailyData, location); const withSpecies=computeSpeciesForLocation(location, base); allForecastData.push(withSpecies); return withSpecies; }catch(err){ console.error('Error',location.name,err); showNotification((isEU()?`${location.name} kokapenaren datuak kargatzean errorea.`:`Error al cargar datos para ${location.name}.`),'error'); return null; }}

function recomputeAllWithSettings(){ // rehace base y especies usando datos ya almacenados en location.forecast
  allForecastData = allForecastData.map(loc=>{ const dailyData = loc.forecast.map(d=>({ date:d.date, rain_for_day:d.rain_for_day, avg_et0:d.avg_et0, temp_min:d.temp_min, temp_max:d.temp_max, avg_humidity:d.avg_humidity, avg_wind_speed:d.avg_wind_speed })); const base=computeBaseProbabilities(dailyData, loc); return computeSpeciesForLocation(loc, base); });
}

/******************** Render ********************/
function slugify(s){ return String(s).toLowerCase().replace(/[^a-z0-9]+/g,'-'); }

function renderLocationCard(location){ const lang=getLang(); const today=todayLocalYYYYMMDD(); const todayIndex=location.forecast.findIndex(d=>d.date===today); const effectiveTodayIndex = (todayIndex!==-1)?todayIndex:0; const todayForecast = location.forecast[effectiveTodayIndex] || { chance:'Baja', score:'0%', top_species:null };
  const cardChanceClass=`card-chance-${todayForecast.chance}`; const cid=`chart-${slugify(location.name)}`; const speciesCid=`species-${slugify(location.name)}`;
  const card=document.createElement('div'); card.className=`bg-white shadow-xl rounded-xl overflow-hidden transform transition-all duration-300 hover:scale-105 card-item ${cardChanceClass}`; card.dataset.chance=todayForecast.chance; card.dataset.name=location.name;
  const headerRightBtnLabel=(lang==='eu'?'Kendu kokapena':'Eliminar ubicaci√≥n');
  card.innerHTML=`
    <div class="p-6 relative">
      <div class="flex justify-between items-start mb-4">
        <div>
          <h4 class="text-2xl font-bold text-gray-800">${location.name}</h4>
          <div class="text-xs text-gray-600 mt-1">${Number(location.lat).toFixed(5)}, ${Number(location.lon).toFixed(5)}${Number.isFinite(location.altitude)?` ¬∑ ${Math.round(location.altitude)} m`:''}</div>
        </div>
        <div class="flex items-center space-x-2">
          <button class="remove-location-btn p-2 text-gray-400 hover:text-red-600 text-lg" aria-label="${headerRightBtnLabel}" data-location-name="${location.name}">
            <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
          </button>
        </div>
      </div>

      <div class="w-full h-48 mb-4"><canvas id="${cid}"></canvas></div>

      <div class="mb-4">
        <h5 class="font-bold text-gray-800 mb-2" data-i18n="speciesTitle">${I18N[lang].speciesTitle}</h5>
        <div class="w-full h-40"><canvas id="${speciesCid}"></canvas></div>
      </div>

      <div class="full-forecast border-t border-gray-200 pt-4">
        <h5 class="font-bold text-gray-800 mb-2">${I18N[lang].forecast7}</h5>
        <ul class="space-y-2">
          ${location.forecast.slice(effectiveTodayIndex, effectiveTodayIndex+7).map((day,index)=>{ const topK=day.top_species; const meta = topK? SPECIES_META[topK]: null; const chip = meta? `<span class=\"chip\" style=\"background:${meta.light}; color:${meta.color}\">‚óè ${SETTINGS.species[topK].label}</span>`:''; const label=fmtWeekdayDayMonthShort(day.date, lang); const chanceText=I18N[lang].chanceMap[day.chance]||day.chance; const chanceClass=day.chance==='Alta'?'bg-green-600 text-white':(day.chance==='Media'?'bg-yellow-600 text-white':'bg-red-600 text-white'); return `
            <li class=\"flex flex-col text-sm text-gray-600 border-b border-gray-200 last:border-b-0 py-2\">
              <div class=\"flex justify-between items-center\">
                <div class=\"flex-1 flex flex-wrap items-center gap-2 pr-2\">
                  <span class=\"font-semibold\">${label}</span>
                  <span class=\"font-semibold text-gray-800\">${getWeatherIcon(day.weather_code||0)} ${day.temp_min.toFixed(0)}¬∞C - ${day.temp_max.toFixed(0)}¬∞C</span>
                  <span class=\"font-semibold text-gray-800\">${(day.rain_for_day||0).toFixed(1)}mm</span>
                  ${chip}
                </div>
                <div class=\"flex items-center space-x-2\">
                  <span class=\"px-2 py-1 text-xs font-bold rounded-full ${chanceClass}\">${chanceText}</span>
                  <button class=\"toggle-score-btn text-gray-400 hover:text-green-600 text-lg\" data-target-id=\"score-details-${slugify(location.name)}-${index}\">&#9432;</button>
                </div>
              </div>
              <div id=\"score-details-${slugify(location.name)}-${index}\" class=\"score-breakdown-details text-xs mt-2 w-full pl-4 hidden\">
                <p class=\"font-bold text-gray-700\">${I18N[lang].score}: <span class=\"text-green-800\">${day.score}</span></p>
                <ul class=\"score-breakdown text-xs text-gray-600\">${(day.score_breakdown||[]).map(item=>`<li>${item}</li>`).join('')}</ul>
              </div>
            </li>`; }).join('')}
        </ul>
      </div>
    </div>`;

  document.getElementById('grid').appendChild(card);

  // Hist√≥rico claro (barras lluvia, l√≠nea temp, l√≠nea ET0, √°rea SMI)
  { const historyData=location.forecast.slice(Math.max(0,effectiveTodayIndex-7), effectiveTodayIndex); const dates=historyData.map(d=>fmtDayMonthShort(d.date, lang)); const temps=historyData.map(d=> d.tmed || (d.temp_min+d.temp_max)/2 ); const rain=historyData.map(d=> d.rain_for_day || 0); const et0=historyData.map(d=> d.avg_et0 || 0); const smi=historyData.map(d=> d.smi!=null? d.smi*100 : null ); new Chart(document.getElementById(cid).getContext('2d'), { type:'bar', data:{ labels:dates, datasets:[ {type:'bar', label:I18N[lang].chart.rain, data:rain, backgroundColor:'rgba(59,130,246,0.35)', borderColor:'#3b82f6', borderWidth:1, yAxisID:'yRain'}, {type:'line', label:I18N[lang].chart.temp, data:temps, borderColor:'#ef4444', pointRadius:2, tension:.25, yAxisID:'yTemp'}, {type:'line', label:I18N[lang].chart.et0, data:et0, borderColor:'#10b981', borderDash:[6,4], pointRadius:2, tension:.25, yAxisID:'yEt0'}, {type:'line', label:I18N[lang].chart.smi, data:smi, borderColor:'#06b6d4', backgroundColor:'rgba(6,182,212,0.18)', fill:'start', pointRadius:0, tension:.25, yAxisID:'ySmi'} ]}, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:true, position:'top'}, tooltip:{ callbacks:{ label:(ctx)=>{ const label=ctx.dataset.label||''; const v=ctx.parsed.y; if(ctx.dataset.yAxisID==='yTemp') return `${label}: ${v.toFixed(1)} ¬∞C`; if(ctx.dataset.yAxisID==='yRain') return `${label}: ${v.toFixed(1)} mm`; if(ctx.dataset.yAxisID==='yEt0') return `${label}: ${v.toFixed(1)} mm`; if(ctx.dataset.yAxisID==='ySmi') return `${label}: ${v.toFixed(0)} %`; return `${label}: ${v}`; } } } }, scales:{ yTemp:{ position:'left', grid:{drawOnChartArea:true}, ticks:{ callback:(v)=>`${v}¬∞` } }, yRain:{ position:'right', grid:{drawOnChartArea:false} }, yEt0:{ position:'right', grid:{drawOnChartArea:false}, display:false }, ySmi:{ position:'right', grid:{drawOnChartArea:false}, offset:true, min:0, max:100, ticks:{ callback:(v)=>`${v}%` } } } } }); }

  // Especies pr√≥ximos 7 d√≠as
  const next7=location.forecast.slice(effectiveTodayIndex, effectiveTodayIndex+7); const dayLabels=next7.map(d=>fmtWeekdayDayMonthShort(d.date, lang)); const spKeys=Object.keys(SETTINGS.species); const stacked=spKeys.map(k=>({ label:SETTINGS.species[k].label, data:next7.map(d=>(d.species?.[k]||0)), backgroundColor:SPECIES_META[k].color, stack:'sp' })); const baseLine={ type:'line', label:(isEU()?'Oinarri‚Äëprob.':'Probabilidad base'), data: next7.map(d=>d.baseProb), borderColor:'#9CA3AF', borderWidth:2, pointRadius:0, yAxisID:'y' };
  new Chart(document.getElementById(speciesCid).getContext('2d'), { type:'bar', data:{ labels:dayLabels, datasets:[...stacked, baseLine] }, options:{ responsive:true, maintainAspectRatio:false, scales:{ x:{stacked:true}, y:{stacked:true, max:100, ticks:{ callback:(v)=> v+'%' }} }, plugins:{ legend:{ display:false } } } });

  // remove
  card.querySelector('.remove-location-btn').addEventListener('click',(e)=>{ const name=e.currentTarget.dataset.locationName; LOCATIONS=LOCATIONS.filter(l=>l.name!==name); allForecastData=allForecastData.filter(l=>l.name!==name); saveLocations(); refreshGrid(); });
}

function refreshGrid(){ const grid=document.getElementById('grid'); grid.innerHTML=''; const today=todayLocalYYYYMMDD(); const filtered=allForecastData.filter(loc=>{ const i=loc.forecast.findIndex(d=>d.date===today); const ch=loc.forecast[i!==-1?i:0]?.chance||'Baja'; return currentFilter==='all'||ch===currentFilter; }); if(filtered.length===0 && allForecastData.length>0){ grid.innerHTML = `<p class="text-center text-gray-500 col-span-full">${isEU()?'Ez dago filtroarekin bat datorren kokapenik.':'No hay ubicaciones que coincidan con el filtro.'}</p>`; } else if(allForecastData.length===0){ document.getElementById('welcome-message').classList.remove('hidden'); } else { document.getElementById('welcome-message').classList.add('hidden'); filtered.sort((a,b)=>{ const today=todayLocalYYYYMMDD(); const aC=a.forecast.find(d=>d.date===today)?.chance||'Baja'; const bC=b.forecast.find(d=>d.date===today)?.chance||'Baja'; if(currentSort==='chance'){ const order={'Alta':0,'Media':1,'Baja':2}; return (order[aC]-order[bC])||a.name.localeCompare(b.name);} return a.name.localeCompare(b.name); }).forEach(renderLocationCard); } }

function saveLocations(){ localStorage.setItem('mushroomLocations', JSON.stringify(LOCATIONS)); }
async function loadLocations(){ const saved=localStorage.getItem('mushroomLocations'); LOCATIONS = saved? JSON.parse(saved): DEFAULT_LOCATIONS; document.getElementById('loading-message').classList.remove('hidden'); const res=await Promise.all(LOCATIONS.map(loc=>updateLocationData(loc))); allForecastData=res.filter(l=>l!==null); document.getElementById('loading-message').classList.add('hidden'); refreshGrid(); }

/******************** Luna ********************/
const MOON_PHASE_EMOJI=['üåë','üåí','üåì','üåî','üåï','üåñ','üåó','üåò'];
const MOON_PHASE_NAME={ es:['Luna Nueva','Luna Creciente','Cuarto Creciente','Luna Gibosa Creciente','Luna Llena','Luna Gibosa Menguante','Cuarto Menguante','Luna Menguante'], eu:['Ilargi berria','Ilgora','Laurden gorantz','Ilgora handitua','Ilargi betea','Ilbehera handitua','Laurden beherantz','Ilbehera'] };
function getMoonPhaseFrac(date){ const jul=date.getTime()/86400000+2440587.5; const cycle=29.53058867; const new1970=2440409.5; const diff=jul-new1970; const phase=diff%cycle; return phase/cycle; }
function getMoonIndex(date){ let idx=Math.floor(getMoonPhaseFrac(date)*8); return idx===8?0:idx; }
function nextFullMoon(date){ for(let i=1;i<=40;i++){ const n=new Date(date); n.setDate(date.getDate()+i); if(getMoonIndex(n)===4) return n; } return null; }
function renderMoonPhase(){ const lang=getLang(); const today=new Date(); const idx=getMoonIndex(today); const emoji=MOON_PHASE_EMOJI[idx]; const name=MOON_PHASE_NAME[lang][idx]; const nextFM=nextFullMoon(today); document.getElementById('moon-emoji').textContent=emoji; document.getElementById('moon-phase-name').textContent=name; document.getElementById('next-full-moon').textContent=(I18N[lang].moon.next)+(nextFM? fmtDayMonthLong(nextFM, lang):'‚Äî'); }

/******************** B√∫squeda ********************/
const searchButton=document.getElementById('search-button'); const locationNameInput=document.getElementById('location-name'); const searchResultsDiv=document.getElementById('search-results'); const searchStatusP=document.getElementById('search-status'); const addLocationBtn=document.getElementById('add-location-btn'); const habitatSelect=document.getElementById('habitat-select'); const ageSelect=document.getElementById('age-select'); const soilSelect=document.getElementById('soil-select'); let foundLocation=null;
async function doSearch(){ const lang=getLang(); const query=locationNameInput.value.trim(); if(query===''){ showNotification(I18N[lang].loading.replace('Cargando','Especifica un lugar'), 'warning'); return;} searchStatusP.innerHTML = `${lang==='eu'?'Bilatzen':'Buscando'} <b>${query}</b>... <span class="loading-spinner inline-block align-middle ml-2"></span>`; searchResultsDiv.classList.remove('hidden'); addLocationBtn.classList.add('hidden'); addLocationBtn.textContent=I18N[lang].add.addBtn; try{ const bbox=`${NAVARRA_BBOX.minLon},${NAVARRA_BBOX.minLat},${NAVARRA_BBOX.maxLon},${NAVARRA_BBOX.maxLat}`; const r=await fetch(`${NOMINATIM_API_URL}?q=${encodeURIComponent(query)}&format=json&limit=1&bounded=1&viewbox=${bbox}&addressdetails=1&namedetails=1`); const data=await r.json(); if(data && data.length>0){ const loc=data[0]; const lat=parseFloat(loc.lat), lon=parseFloat(loc.lon); if(lat>=NAVARRA_BBOX.minLat && lat<=NAVARRA_BBOX.maxLat && lon>=NAVARRA_BBOX.minLon && lon<=NAVARRA_BBOX.maxLon){ const name = loc.namedetails?.["name:eu"] || loc.display_name.split(',')[0]; const province=loc.address?.state || loc.address?.province ||""; const municipality=loc.address?.town || loc.address?.city || loc.address?.village ||""; const country=loc.address?.country ||""; foundLocation={ name, lat, lon, province, municipality, country }; searchStatusP.innerHTML = `<b>${name}</b><br>${I18N[lang].add.resultsProvince}: ${province||'‚Äî'}<br>${I18N[lang].add.resultsMunicipality}: ${municipality||'‚Äî'}<br>${I18N[lang].add.resultsCountry}: ${country||'‚Äî'}<br>${I18N[lang].add.resultsCoords}: (Lat: ${lat.toFixed(4)}, Lon: ${lon.toFixed(4)})`; addLocationBtn.textContent=`${I18N[lang].add.addBtn.replace('"','')} \"${name}\"`; addLocationBtn.classList.remove('hidden'); } else { searchStatusP.textContent = (lang==='eu'?'Kokapena Nafarroatik kanpo dago.':'La ubicaci√≥n est√° fuera de Navarra.'); foundLocation=null; } } else { searchStatusP.textContent=(lang==='eu'?'Ez da kokapena aurkitu.':'Ubicaci√≥n no encontrada.'); foundLocation=null; } }catch(e){ searchStatusP.textContent=(lang==='eu'?'Errorea bilaketan.':'Error al buscar la ubicaci√≥n.'); console.error(e); foundLocation=null; } }
searchButton.addEventListener('click', doSearch);
addLocationBtn.addEventListener('click', async ()=>{ const lang=getLang(); if(foundLocation){ if(!LOCATIONS.find(l=>l.name===foundLocation.name)){ const newLoc={ ...foundLocation, habitat:habitatSelect.value||undefined, ageClass:ageSelect.value||undefined, soilAcidity:soilSelect.value||undefined }; LOCATIONS.push(newLoc); saveLocations(); locationNameInput.value=''; habitatSelect.value=''; ageSelect.value=''; soilSelect.value=''; searchResultsDiv.classList.add('hidden'); document.getElementById('loading-message').classList.remove('hidden'); const result=await updateLocationData(newLoc); document.getElementById('loading-message').classList.add('hidden'); if(result) refreshGrid(); } else { searchStatusP.textContent = (lang==='eu'?'Dagoeneko badago zerrendan.':'Esta ubicaci√≥n ya est√° en su lista.'); } } });

/******************** Controles filtro/orden ********************/
function hookControls(){ const filterButtons=document.querySelectorAll('.filter-btn'); filterButtons.forEach(btn=>btn.addEventListener('click',(e)=>{ filterButtons.forEach(b=>b.classList.remove('bg-gray-400','text-white')); e.target.classList.add('bg-gray-400','text-white'); currentFilter=e.target.dataset.filter; refreshGrid(); })); const sortButtons=document.querySelectorAll('.sort-btn'); sortButtons.forEach(btn=>btn.addEventListener('click',(e)=>{ sortButtons.forEach(b=>b.classList.remove('bg-gray-400','text-white')); e.target.classList.add('bg-gray-400','text-white'); currentSort=e.target.dataset.sort; refreshGrid(); })); }

/******************** Ayuda ********************/
function fillHelpLists(){ const lang=getLang(); const ul=document.getElementById('help-list'); const us=document.getElementById('help-species'); ul.innerHTML=I18N[lang].help.list.map(s=>`<li>${s}</li>`).join(''); us.innerHTML=I18N[lang].help.speciesList.map(s=>`<li>${s}</li>`).join(''); }

/******************** Settings UI ********************/
function openSettings(){ document.getElementById('settings-modal').style.display='block'; bindSettingsUI(); }
function closeSettings(){ document.getElementById('settings-modal').style.display='none'; }
function fillSettingsI18N(){ const lang=getLang(); document.querySelectorAll('#settings-modal [data-i18n]').forEach(el=>{ const k=el.getAttribute('data-i18n'); const v=t(k); if(v!=null) el.textContent=v; }); }

function getByPath(obj, path){ return path.split('.').reduce((o,k)=> (o? o[k]: undefined), obj); }
function setByPath(obj, path, val){ const parts=path.split('.'); const last=parts.pop(); const target=parts.reduce((o,k)=> (o[k]??(o[k] = {})), obj); target[last]=val; }
function bindSettingsUI(){ // inputs
  document.querySelectorAll('#settings-modal [data-set]').forEach(inp=>{ const path=inp.getAttribute('data-set'); const val=getByPath(SETTINGS, path); if(val!=null) inp.value=val; inp.oninput = debounce(()=>{ const v = parseFloat(inp.value); setByPath(SETTINGS, path, isNaN(v)? inp.value : v); saveSettings(); applySettingsAndRefresh(); }, 200); });
  // species dynamic forms
  buildSpeciesForms();
}
function buildSpeciesForms(){ const wrap=document.getElementById('species-forms'); if(!wrap) return; const lang=getLang(); const spKeys=Object.keys(SETTINGS.species); const lblTemp=t('settings.sp.temp'); const lblSmi=t('settings.sp.smi'); const lblSeason=t('settings.sp.season'); const lblSeason2=t('settings.sp.season2'); const lblLabel=t('settings.sp.label'); wrap.innerHTML = spKeys.map(key=>{ const sp=SETTINGS.species[key]; return `<div class=\"bg-white rounded-lg p-3 border\">
  <p class=\"font-semibold mb-2\">${sp.label}</p>
  <label class=\"grid-field text-sm\"><span>${lblLabel}</span><input data-set=\"species.${key}.label\" type=\"text\" class=\"border rounded p-1 w-48\"></label>
  <label class=\"grid-field text-sm\"><span>${lblTemp}</span><span><input data-set=\"species.${key}.temp.min\" type=\"number\" step=\"0.5\" class=\"border rounded p-1 w-20\">‚Äë<input data-set=\"species.${key}.temp.max\" type=\"number\" step=\"0.5\" class=\"border rounded p-1 w-20\"></span></label>
  <label class=\"grid-field text-sm\"><span>${lblSmi}</span><span><input data-set=\"species.${key}.smi.lo\" type=\"number\" step=\"0.01\" class=\"border rounded p-1 w-20\">‚Äë<input data-set=\"species.${key}.smi.hi\" type=\"number\" step=\"0.01\" class=\"border rounded p-1 w-20\"></span></label>
  <label class=\"grid-field text-sm\"><span>${lblSeason}</span><span><input data-set=\"species.${key}.season.mu\" type=\"number\" step=\"1\" class=\"border rounded p-1 w-20\">,<input data-set=\"species.${key}.season.sigma\" type=\"number\" step=\"1\" class=\"border rounded p-1 w-20\"></span></label>
  ${(key==='boletus')? `<label class=\"grid-field text-sm\"><span>${lblSeason2}</span><span><input data-set=\"species.${key}.season.mu2\" type=\"number\" step=\"1\" class=\"border rounded p-1 w-20\">,<input data-set=\"species.${key}.season.sigma2\" type=\"number\" step=\"1\" class=\"border rounded p-1 w-20\"></span></label>`: ''}
</div>`; }).join('');
  // bind
  wrap.querySelectorAll('[data-set]').forEach(inp=>{ const path=inp.getAttribute('data-set'); const val=getByPath(SETTINGS, path); if(val!=null) inp.value=val; inp.oninput = debounce(()=>{ const v = (inp.type==='text')? inp.value : parseFloat(inp.value); setByPath(SETTINGS, path, (inp.type==='text')? v : (isNaN(v)? 0 : v)); saveSettings(); applySettingsAndRefresh(); }, 200); });
}

function debounce(fn,ms){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(this,args),ms); }; }
function applySettingsAndRefresh(){ recomputeAllWithSettings(); refreshGrid(); showNotification(isEU()? 'Ezarpenak aplikatu dira.' : 'Ajustes aplicados.', 'info'); }

/******************** Idioma y arranque ********************/
function applyLanguage(){ applyStaticI18N(); fillSelectOptions(); fillHelpLists(); renderMoonPhase(); refreshGrid(); }

document.addEventListener('DOMContentLoaded', async ()=>{ setLang(getLang()); applyLanguage(); const helpBtn=document.getElementById('help-button'); const helpModal=document.getElementById('help-modal'); const settingsBtn=document.getElementById('settings-button'); const settingsModal=document.getElementById('settings-modal'); document.querySelectorAll('.modal .close-x').forEach(x=>x.onclick=()=> x.closest('.modal').style.display='none'); helpBtn.onclick=()=> helpModal.style.display='block'; settingsBtn.onclick=()=> openSettings(); window.onclick=(e)=>{ if(e.target===helpModal) helpModal.style.display='none'; if(e.target===settingsModal) settingsModal.style.display='none'; };
  // tabs ajustes
  document.querySelectorAll('#settings-modal .tab').forEach(tab=>{ tab.addEventListener('click',()=>{ document.querySelectorAll('#settings-modal .tab').forEach(x=>x.classList.remove('active')); tab.classList.add('active'); const id=tab.getAttribute('data-tab'); document.querySelectorAll('#settings-modal .section').forEach(sec=>sec.classList.remove('active')); document.getElementById('section-'+id).classList.add('active'); }); });
  document.getElementById('close-settings').onclick=closeSettings; document.getElementById('close-settings-2').onclick=closeSettings; document.getElementById('close-settings-3').onclick=closeSettings; document.getElementById('reset-settings').onclick=()=>{ SETTINGS=deepClone(DEFAULT_SETTINGS); saveSettings(); bindSettingsUI(); applySettingsAndRefresh(); }; document.getElementById('reset-triggers').onclick=()=>{ SETTINGS.triggers=deepClone(DEFAULT_SETTINGS.triggers); saveSettings(); bindSettingsUI(); applySettingsAndRefresh(); }; document.getElementById('reset-species').onclick=()=>{ SETTINGS.species=deepClone(DEFAULT_SETTINGS.species); saveSettings(); bindSettingsUI(); applySettingsAndRefresh(); };
  hookControls(); await loadLocations(); });

// idioma toggle
window.__toggleLang = function(){ const next=(getLang()==='eu')?'es':'eu'; setLang(next); applyLanguage(); };
document.getElementById('__langBtn').addEventListener('click', ()=> window.__toggleLang());

// Info breakdown toggle (delegaci√≥n)
(function(){ const grid=document.getElementById('grid'); if(!grid) return; grid.addEventListener('click',(ev)=>{ const btn=ev.target.closest('.toggle-score-btn'); if(!btn) return; const card=btn.closest('.card-item')||grid; const id=btn.dataset.targetId; const sel = '#'+(window.CSS&&CSS.escape? CSS.escape(id): id); const details=card.querySelector(sel)||document.getElementById(id); if(details){ const hidden=details.classList.toggle('hidden'); btn.setAttribute('aria-expanded', (!hidden).toString()); } }); })();

// Traducci√≥n del breakdown (ES<>EU) en DOM
(function(){ if(window.__scoreI18N) return; window.__scoreI18N=true; const R={ es2eu:[ [/^Suelo h√∫medo \(SMI ‚â• 0\.7\)(.*)$/i,'Lurzoru hezea (SMI ‚â• 0.7)$1'], [/^Suelo con humedad media \(SMI ‚â• 0\.5\)(.*)$/i,'Lurzoru ertain-hezea (SMI ‚â• 0.5)$1'], [/^Suelo algo seco \(SMI > 0\.3\)(.*)$/i,'Lurzoru pixka bat lehorra (SMI > 0.3)$1'], [/^Suelo seco \(SMI ‚â§ 0\.3\)(.*)$/i,'Lurzoru lehorra (SMI ‚â§ 0.3)$1'], [/^Brote tras lluvia reciente \(\+([0-9.]+)\)$/i,'Euri ondoren agerpena (+$1)'], [/^Temp\. √≥ptima \(([0-9]+)[‚Äì-]([0-9]+)¬∞C\) \(\+?([0-9.]+)\)$/i,'Tenperatura egokia ($1‚Äì$2¬∞C) (+$3)'], [/^Calor alto \(>([0-9]+)¬∞C\) \(([‚àí-]?[0-9.]+)\)$/i,'Bero handia (>$1¬∞C) ($2)'], [/^VPD bajo \(\+([0-9.]+)\)$/i,'VPD baxua (+$1)'], [/^VPD medio \(\+([0-9.]+)\)$/i,'VPD ertaina (+$1)'], [/^VPD alto \(([‚àí-]?[0-9.]+)\)$/i,'VPD handia ($1)'], [/^Viento\+calor \(([‚àí-]?[0-9.]+)\)$/i,'Haizea+bero ($1)'], [/^Heladas recientes \(([‚àí-]?[0-9.]+)\)$/i,'Azken izozteak ($1)'], [/^Alta monta√±a \(>1000 m, retraso temporada\) \(([‚àí-]?[0-9.]+)\)$/i,'Mendi garaia (>1000 m, sasoiaren atzerapena) ($1)'], [/^Zona baja y temporada temprana \(([‚àí-]?[0-9.]+)\)$/i,'Behe‚Äëaldea eta sasoi goiztiarra ($1)'], [/^Factor de h√°bitat √ó([0-9.]+)$/i,'Habitat faktorea √ó$1'] ], eu2es:[ [/^Lurzoru hezea \(SMI ‚â• 0\.7\)(.*)$/i,'Suelo h√∫medo (SMI ‚â• 0.7)$1'], [/^Lurzoru ertain-hezea \(SMI ‚â• 0\.5\)(.*)$/i,'Suelo con humedad media (SMI ‚â• 0.5)$1'], [/^Lurzoru pixka bat lehorra \(SMI > 0\.3\)(.*)$/i,'Suelo algo seco (SMI > 0.3)$1'], [/^Lurzoru lehorra \(SMI ‚â§ 0\.3\)(.*)$/i,'Suelo seco (SMI ‚â§ 0.3)$1'], [/^Euri ondoren agerpena \(\+([0-9.]+)\)$/i,'Brote tras lluvia reciente (+$1)'], [/^Tenperatura egokia \(([0-9]+)[‚Äì-]([0-9]+)¬∞C\) \(\+?([0-9.]+)\)$/i,'Temp. √≥ptima ($1‚Äì$2¬∞C) (+$3)'], [/^Bero handia \(>([0-9]+)¬∞C\) \(([‚àí-]?[0-9.]+)\)$/i,'Calor alto (>$1¬∞C) ($2)'], [/^VPD baxua \(\+([0-9.]+)\)$/i,'VPD bajo (+$1)'], [/^VPD ertaina \(\+([0-9.]+)\)$/i,'VPD medio (+$1)'], [/^VPD handia \(([‚àí-]?[0-9.]+)\)$/i,'VPD alto ($1)'], [/^Haizea\+bero \(([‚àí-]?[0-9.]+)\)$/i,'Viento+calor ($1)'], [/^Azken izozteak \(([‚àí-]?[0-9.]+)\)$/i,'Heladas recientes ($1)'], [/^Mendi garaia \(>1000 m, sasoiaren atzerapena\) \(([‚àí-]?[0-9.]+)\)$/i,'Alta monta√±a (>1000 m, retraso temporada) ($1)'], [/^Behe‚Äëaldea eta sasoi goiztiarra \(([‚àí-]?[0-9.]+)\)$/i,'Zona baja y temporada temprana ($1)'], [/^Habitat faktorea √ó([0-9.]+)$/i,'Factor de h√°bitat √ó$1'] ] };
  function trLine(txt,toEU){ const pairs=toEU?R.es2eu:R.eu2es; for(const [re,rep] of pairs){ if(re.test(txt)) return txt.replace(re,rep); } return txt; }
  function translateBreakdownsInDOM(){ const toEU=(localStorage.getItem('app_lang')==='eu'); document.querySelectorAll('#grid .score-breakdown li').forEach(li=>{ const t=(li.textContent||'').trim(); const nt=trLine(t,toEU); if(nt!==t) li.textContent=nt; }); document.querySelectorAll('#grid .score-breakdown-details p.font-bold').forEach(p=>{ const lang=getLang(); const label=(lang==='eu'?'Puntuazioa':'Puntuaci√≥n'); const span=p.querySelector('span'); p.textContent=label+': '; if(span) p.appendChild(span); }); }
  const prevToggle=window.__toggleLang; window.__toggleLang=function(){ const r=(prevToggle?prevToggle.apply(this,arguments):null); translateBreakdownsInDOM(); return r; };
  const prevRefresh=window.refreshGrid; window.refreshGrid=function(){ const r=prevRefresh.apply(this,arguments); translateBreakdownsInDOM(); return r; };
})();
</script>
</body>
</html>
